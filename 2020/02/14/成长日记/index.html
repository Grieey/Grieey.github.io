<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="John Doe" />
  <meta name="description" content="" />
  
  
  <title>
    
      成长日记 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">LEEDOM</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/leedom92/hexo-theme-leedom">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="" href="">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="facebook" target="" href="">
      <i class="iconfont icon-facebooksquare"></i>
    </a>
  
    <a title="twitter" target="" href="">
      <i class="iconfont icon-twitter"></i>
    </a>
  
    <a title="wechat" target="" href="">
      <i class="iconfont icon-wechat"></i>
    </a>
  
    <a title="weibo" target="" href="">
      <i class="iconfont icon-weibo"></i>
    </a>
  
    <a title="rss" target="_blank" href="/atom.xml">
      <i class="iconfont icon-rss"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Feb 14, 2020
  </h3>
  <h1>
    成长日记
  </h1>
  <div class="content markdown-body">
    <p>根据下图所示的文字绘制</p>
<p><img src="https://upload-images.jianshu.io/upload_images/379614-cfb6c687adfc2103.jpg" alt="图1"></p>
<p>要去除最后一行的行间距，就需要整体的高度减去最后一行的 rect.bottom - descent 这个值。核心逻辑如下:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculateExtraSpace</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> lastRowSpace = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (lineCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//实际最后一行</span></span><br><span class="line">      <span class="keyword">val</span> actualLastRowIndex = lineCount - <span class="number">1</span></span><br><span class="line">      <span class="comment">//显示的最后一行</span></span><br><span class="line">      <span class="keyword">val</span> lastRowIndex = Math.min(maxLines, lineCount) - <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (lastRowIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> layout = layout</span><br><span class="line">        <span class="comment">//显示的最后一行文字基线坐标</span></span><br><span class="line">        <span class="keyword">val</span> baseline = getLineBounds(lastRowIndex, mLastLineShowRect)</span><br><span class="line">        getLineBounds(actualLastRowIndex, mLastLineActualIndexRect)</span><br><span class="line">        <span class="comment">//测量显示的高度（measureHeight）等于TextView实际高度（layout.getHeight()）或者等于实际高度减去不可见部分的高度（mLastLineActualIndexRect.bottom - mLastLineShowRect.bottom）</span></span><br><span class="line">        <span class="keyword">if</span> (measuredHeight == layout.height - (mLastLineActualIndexRect.bottom - mLastLineShowRect.bottom)) &#123;</span><br><span class="line">          lastRowSpace = mLastLineShowRect.bottom - (baseline + layout.paint.fontMetricsInt.descent)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lastRowSpace</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">    <span class="comment">//去除显示的最后一行的行间距</span></span><br><span class="line">    <span class="comment">//设置行间距 &amp;&amp; 设置MaxLines &amp;&amp; 实际行数大于MaxLines时，显示的最后一行会增加行间距</span></span><br><span class="line">    <span class="comment">//Redmi 3(android 5.1.1)</span></span><br><span class="line">    <span class="comment">//HuaWei nova youth(EMUI 5.1 andorid 7.0)</span></span><br><span class="line">    <span class="comment">//oppo R7(ColorOs v2.1 android 4.4.4)，只要设置了间距，默认最后一行都会增加间距</span></span><br><span class="line">    setMeasuredDimension(measuredWidth, measuredHeight - calculateExtraSpace())</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-02-x2F-18"><a href="#2020-x2F-02-x2F-18" class="headerlink" title="2020&#x2F;02&#x2F;18"></a>2020&#x2F;02&#x2F;18</h2><h3 id="关于-textView-中-measure-错误的-bug-分析"><a href="#关于-textView-中-measure-错误的-bug-分析" class="headerlink" title="关于 textView 中 measure 错误的 bug 分析"></a>关于 textView 中 measure 错误的 bug 分析</h3><blockquote>
<p>现象是在某些情况下，textView 的高度与内容的高度不一致，导致显示不完全，页面刷新重新绘制后就好了</p>
</blockquote>
<p>看了网路上一篇文章的大概分析，主要的代码为 textview 中关于 setText 方法调用后，有没有触发 requestLayout 方法（这个方法中会调用控件的 onMeasure方法和 onLayout 方法，重新测量）,核心方法是 textView 的 checkForRelayout()这个方法中的判断，如果控件的宽度为 wrap_content 的话，会直接调用，大概的判断逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Check whether entirely new text requires a new view layout</span></span><br><span class="line"><span class="comment">   * or merely a new text layout.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkForRelayout</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// If we have a fixed width, we can just swap in a new text layout</span></span><br><span class="line">      <span class="comment">// if the text height stays the same or if the view height is fixed.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((mLayoutParams.width != LayoutParams.WRAP_CONTENT</span><br><span class="line">              || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))</span><br><span class="line">              &amp;&amp; (mHint == <span class="literal">null</span> || mHintLayout != <span class="literal">null</span>)</span><br><span class="line">              &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="comment">// Static width, so try making a new text layout.</span></span><br><span class="line"></span><br><span class="line">          <span class="type">int</span> <span class="variable">oldht</span> <span class="operator">=</span> mLayout.getHeight();</span><br><span class="line">          <span class="type">int</span> <span class="variable">want</span> <span class="operator">=</span> mLayout.getWidth();</span><br><span class="line">          <span class="type">int</span> <span class="variable">hintWant</span> <span class="operator">=</span> mHintLayout == <span class="literal">null</span> ? <span class="number">0</span> : mHintLayout.getWidth();</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * No need to bring the text into view, since the size is not</span></span><br><span class="line"><span class="comment">           * changing (unless we do the requestLayout(), in which case it</span></span><br><span class="line"><span class="comment">           * will happen at measure).</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,</span><br><span class="line">                        mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(),</span><br><span class="line">                        <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mEllipsize != TextUtils.TruncateAt.MARQUEE) &#123;</span><br><span class="line">              <span class="comment">// In a fixed-height view, so use our new text layout.</span></span><br><span class="line">              <span class="keyword">if</span> (mLayoutParams.height != LayoutParams.WRAP_CONTENT</span><br><span class="line">                      &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                  autoSizeText();</span><br><span class="line">                  invalidate();</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// Dynamic height, but height has stayed the same,</span></span><br><span class="line">              <span class="comment">// so use our new text layout.</span></span><br><span class="line">              <span class="keyword">if</span> (mLayout.getHeight() == oldht</span><br><span class="line">                      &amp;&amp; (mHintLayout == <span class="literal">null</span> || mHintLayout.getHeight() == oldht)) &#123;</span><br><span class="line">                  autoSizeText();</span><br><span class="line">                  invalidate();</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// We lose: the height has changed and we have a dynamic height.</span></span><br><span class="line">          <span class="comment">// Request a new view layout using our new text layout.</span></span><br><span class="line">          requestLayout();</span><br><span class="line">          invalidate();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Dynamic width, so we have no choice but to request a new</span></span><br><span class="line">          <span class="comment">// view layout with a new text layout.</span></span><br><span class="line">          nullLayouts();</span><br><span class="line">          requestLayout();</span><br><span class="line">          invalidate();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>所以暂时将控件的宽度修改为 wrap_content 来解决，但是该问题没有完全找到复现的原因，这是猜测，后续可以进行 demo 复现，还有一点思考的是只有这个地方出现了这种情况，测试的环境是弱网的特别容易复现</p>
<h2 id="2020-x2F-02-x2F-19"><a href="#2020-x2F-02-x2F-19" class="headerlink" title="2020&#x2F;02&#x2F;19"></a>2020&#x2F;02&#x2F;19</h2><h3 id="使用-EpoxyModelGroup-时动态改变-items-的问题"><a href="#使用-EpoxyModelGroup-时动态改变-items-的问题" class="headerlink" title="使用 EpoxyModelGroup 时动态改变 items 的问题"></a>使用 EpoxyModelGroup 时动态改变 items 的问题</h3><p>在分离了动态流中一个动态的各个部分后，为了复用，使用 EpoxyModelGroup 来实现的转发动态的展示，但是不同类型的转发动态展示的 item 不一样，造成 items 的改变，然后就给报错了，看了 EpoxyModelGroup 的类注释，因为它在第一次使用的时候，会根据第一次传入的 items 的 Model 来加载对应的布局，所有后面无法动态改变，所以要实现加载不同转发类型的 item，就只有将所有的类型罗列出，并按照<strong>一定的顺序</strong>排列，依次加载响应的布局，如果不需要显示，就生成空的 item（但是这个 item 的类型要和需要显示的一致，这样加载的布局才会是正确的），然后调用 <code>hide()</code>方法</p>
<h2 id="2020-x2F-02-x2F-21"><a href="#2020-x2F-02-x2F-21" class="headerlink" title="2020&#x2F;02&#x2F;21"></a>2020&#x2F;02&#x2F;21</h2><h3 id="使用-ViewStub-加载布局的坑"><a href="#使用-ViewStub-加载布局的坑" class="headerlink" title="使用 ViewStub 加载布局的坑"></a>使用 ViewStub 加载布局的坑</h3><p>使用 ViewStub 加载布局时，cardView 会失效，具体的原因没有深入源码研究</p>
<h3 id="viewModel-死掉的原因分析"><a href="#viewModel-死掉的原因分析" class="headerlink" title="viewModel 死掉的原因分析"></a>viewModel 死掉的原因分析</h3><p>之前一直有偶发性造成 viewModel 假死的情况，已知的是如果用来保存 state 的 Store 在分发订阅时，如果 block 中的代码出现了异常，会造成该线程死掉。分析了 <code>RealMvRxStateStore </code>的代码后发现，该类只会在初始化时进行一次线程的订阅，如果这个订阅的子线程发生了错误，造成线程死掉，后续的操作就无法再唤醒这个线程了，具体造成线程死掉的代码还没有分析到（为死掉后包括 throw 的异常都无法抛出），目前的解决方法就是，增加一个标志位，在线程死掉后，再次增加事件时，会重新订阅。这种处理方法有不妥的地方就是，这次失败的订阅无法回调给上层，需要后续有一次操作来触发重新订阅</p>
<p>后记：最后是暴露出来了一个 callback，用于回调处理发生错误时的后续</p>
<h2 id="2020-x2F-02-x2F-24"><a href="#2020-x2F-02-x2F-24" class="headerlink" title="2020&#x2F;02&#x2F;24"></a>2020&#x2F;02&#x2F;24</h2><h3 id="animation-在部分手机上存在掉帧的情况"><a href="#animation-在部分手机上存在掉帧的情况" class="headerlink" title="animation 在部分手机上存在掉帧的情况"></a>animation 在部分手机上存在掉帧的情况</h3><p><strong>TODO</strong> :这个在小米手机上很明显，即使是使用线性插值器，中间有一段的数据回调会突然陡增然后恢复，这种情况目前没有测试出原因是什么</p>
<h2 id="2020-x2F-03-x2F-05"><a href="#2020-x2F-03-x2F-05" class="headerlink" title="2020&#x2F;03&#x2F;05"></a>2020&#x2F;03&#x2F;05</h2><h3 id="关于-kotlin-中的泛型"><a href="#关于-kotlin-中的泛型" class="headerlink" title="关于 kotlin 中的泛型"></a>关于 kotlin 中的泛型</h3><ul>
<li>**out ** 关键字：等同于 <code>Java</code> 中的<code>? extend</code>，上界通配符，在泛型中允许泛型的子类赋值</li>
<li>**in **关键字：等同于<code>Java</code>中的<code>? super</code>，下界通配符，在泛型中允许泛型的父类赋值</li>
</ul>
<p>如果需要在泛型中确定某一个泛型的类型，需要使用类型擦除</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T : BaseSysExtraDataBean&gt;</span> <span class="title">getExtraBean</span><span class="params">()</span></span>: T? &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">      GsonUtils.fromJson(<span class="keyword">this</span>.<span class="keyword">data</span>, T::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">      LogUtils.e(<span class="string">&quot;IMMessage：extraBean获取失败 <span class="subst">$&#123;e.cause&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 在上诉代码中，通过使用 <code>inline</code>和<code>reified</code>来实现 Kotlin 中的类型擦除</p>
<h3 id="This-指针逃逸"><a href="#This-指针逃逸" class="headerlink" title="This 指针逃逸"></a>This 指针逃逸</h3><p><strong>TODO</strong>:在阅读到并发编程的对象的共享章节时，书中举例了关于 this 逃逸的案例，不太明白，需要理解</p>
<h3 id="Kotlin调用-Java-中的方法可见性的问题"><a href="#Kotlin调用-Java-中的方法可见性的问题" class="headerlink" title="Kotlin调用 Java 中的方法可见性的问题"></a>Kotlin调用 Java 中的方法可见性的问题</h3><p>今天使用 Kotlin 调用一个 Java 接口时，实现其方法报错了，错误是<code>&#39;public&#39; function exposes its &#39;public/*package*/&#39; parameter type</code> 因为在 Java 中的可见性和 Kotlin 不一样(Java 默认是 <strong>default</strong>，而 Kotlin 默认是 <strong>public</strong>)，所以需要把报错的 class 显示修改为 public</p>
<h2 id="2020-x2F-03-x2F-08"><a href="#2020-x2F-03-x2F-08" class="headerlink" title="2020&#x2F;03&#x2F;08"></a>2020&#x2F;03&#x2F;08</h2><h3 id="cannot-inline-bytecode-built-with-jvm-target-1-8-into-bytecode-that-is-being-built-with-jvm-target-1错误解决方案"><a href="#cannot-inline-bytecode-built-with-jvm-target-1-8-into-bytecode-that-is-being-built-with-jvm-target-1错误解决方案" class="headerlink" title="cannot inline bytecode built with jvm target 1.8 into bytecode that is being built with jvm target 1错误解决方案"></a>cannot inline bytecode built with jvm target 1.8 into bytecode that is being built with jvm target 1错误解决方案</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = JavaVersion.VERSION_1_8.toString()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="getLocationInWindow-和-getLocationOnScreen-两个方法的区别"><a href="#getLocationInWindow-和-getLocationOnScreen-两个方法的区别" class="headerlink" title="getLocationInWindow 和 getLocationOnScreen 两个方法的区别"></a>getLocationInWindow 和 getLocationOnScreen 两个方法的区别</h3><p>顾名思义，前者为获取控件在窗口中的坐标，后者为获取控件在屏幕中的坐标，计算窗口内的坐标时，如果没有特殊设置，不会包含顶部状态栏，实际上计算的就是 activity 顶层 view 内的坐标，而计算屏幕的坐标就是以屏幕为坐标系来计算的</p>
<h2 id="2020-x2F-03-x2F-11"><a href="#2020-x2F-03-x2F-11" class="headerlink" title="2020&#x2F;03&#x2F;11"></a>2020&#x2F;03&#x2F;11</h2><h3 id="关于事件分发的理解"><a href="#关于事件分发的理解" class="headerlink" title="关于事件分发的理解"></a>关于事件分发的理解</h3><p>所有的事件都是由 <strong>DOWN</strong> 事件开始，由<strong>UP</strong>结束，中间夹杂一系列<strong>MOVE</strong>或者<strong>POINTER_DOWN</strong>的事件，所以在进行事件的分发处理时，如果要子 View 对对应的事件做出一定的响应，那么需要根据响应事件所需要的基本事件进行分发，比如，<strong>Click</strong>事件，在某些区域响应点击事件，那么首先 <strong>DOWN</strong> 事件都得分发下去，以便子 View 对后续的事件的判断，然后再根据<strong>UP</strong>的点击区域判断，是否需要将<strong>UP</strong>事件分发还是由自己进行处理</p>
<h2 id="2020-x2F-03-x2F-13"><a href="#2020-x2F-03-x2F-13" class="headerlink" title="2020&#x2F;03&#x2F;13"></a>2020&#x2F;03&#x2F;13</h2><h3 id="Flutter-wait-for-another-……问题解决方案"><a href="#Flutter-wait-for-another-……问题解决方案" class="headerlink" title="Flutter wait for another ……问题解决方案"></a>Flutter wait for another ……问题解决方案</h3><p>首先到<code>SDK/bin/cache/</code>目录下，删除<code>lockfile</code>，然后回到项目中，运行<code>Flutter doctor</code></p>
<h2 id="2020-x2F-03-x2F-16"><a href="#2020-x2F-03-x2F-16" class="headerlink" title="2020&#x2F;03&#x2F;16"></a>2020&#x2F;03&#x2F;16</h2><h3 id="实现-recyclerview-的分组吸顶效果和分割线的大体思路"><a href="#实现-recyclerview-的分组吸顶效果和分割线的大体思路" class="headerlink" title="实现 recyclerview 的分组吸顶效果和分割线的大体思路"></a>实现 recyclerview 的分组吸顶效果和分割线的大体思路</h3><p>可以通过继承<strong>ItemDecoration</strong>来实现，我这里的主要思路是，将数据源中，分组的第一项设置为一个单独的<strong>Item</strong>，然后在自定义的<strong>ItemDecoration</strong>中获取该Item 会非常方便了。</p>
<p>1.分割线的实现</p>
<p>分割线的实现分为简单的增加分离距离和自定义分割线：</p>
<p>前者只需要重写<code>getItemOffsets</code>，根据获取当前的 Item 来获取 Item的位置<code>parent.getChildAdapterPosition(view)</code>,其中的<code>parent</code>和<code>view</code>都是回调返回的变量。然后 设置不同的间距即可（设置<code>OutRect</code>）简单示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemOffsets</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   outRect: <span class="type">Rect</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">   view: <span class="type">View</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">   parent: <span class="type">RecyclerView</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">   state: <span class="type">RecyclerView</span>.<span class="type">State</span></span></span></span><br><span class="line"><span class="params"><span class="function"> )</span></span> &#123;</span><br><span class="line"> 	<span class="keyword">val</span> position = parent.getChildAdapterPosition(view)</span><br><span class="line"> 	<span class="comment">// 获取到 position 后可以根据需求，设置不同的 position 需要什么样的间距</span></span><br><span class="line"> 	<span class="keyword">if</span> (position == XXX)&#123;</span><br><span class="line"> 		... 	</span><br><span class="line"> 		outRect.top = XXX</span><br><span class="line"> 	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> 		...</span><br><span class="line"> 		outRect.top = XXX</span><br><span class="line"> 	&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>如果还要实现自定义的分割线效果，除了上诉一样将间距分开后，还需要重写<code>onDraw(c: Canvas, parent: RecyclerView, state: RecyclerView.State)</code>方法来具体绘制每一个 Item的分割线，这个方法中会回调回来<strong>Canvas</strong>对象，可以用它进行各种的自定义绘制，示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// recyclerview 每一次的绘制都会回调，例如滑动时</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(c: <span class="type">Canvas</span>, parent: <span class="type">RecyclerView</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span> &#123;</span><br><span class="line">     <span class="keyword">val</span> count = parent.adapter?.itemCount ?: <span class="number">0</span></span><br><span class="line">     <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0.</span>.count) &#123;</span><br><span class="line">       <span class="keyword">val</span> item = parent.getChildAt(i)</span><br><span class="line">       item?.let &#123;</span><br><span class="line">         <span class="keyword">val</span> offsetX = item.x.toInt()</span><br><span class="line">         <span class="keyword">val</span> offsetY = item.y.toInt()</span><br><span class="line">         <span class="comment">// 绘制中间的竖直分割线</span></span><br><span class="line">         <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">4</span> != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">val</span> top = <span class="keyword">if</span> (i &lt; <span class="number">4</span>) offsetY <span class="keyword">else</span> offsetY - <span class="number">10</span></span><br><span class="line">           c.drawRect(</span><br><span class="line">             Rect(</span><br><span class="line">               offsetX + item.width,</span><br><span class="line">               top,</span><br><span class="line">               offsetX + item.width + <span class="number">10</span>,</span><br><span class="line">               offsetY + item.height</span><br><span class="line">             ),</span><br><span class="line">             paint</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 除了第一排，绘制顶部的分割线</span></span><br><span class="line">         <span class="keyword">if</span> (i &gt; <span class="number">3</span>) &#123;</span><br><span class="line">           c.drawRect(</span><br><span class="line">             Rect(</span><br><span class="line">               offsetX,</span><br><span class="line">               offsetY - <span class="number">10</span>,</span><br><span class="line">               offsetX + item.width,</span><br><span class="line">               offsetY</span><br><span class="line">             ),</span><br><span class="line">             paint</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;	</span><br></pre></td></tr></table></figure>



<p>2.吸顶效果的实现</p>
<p>吸顶效果的实现主要依靠的重写<code>onDrawOver(c: Canvas, parent: RecyclerView, state: RecyclerView.State)</code>这个方法来实现，这个方法回调回来的<strong>Canvas</strong>对象所绘制的内容是处于 Item 的上层的，一种遮罩的感觉。同时也会返回 <strong>recyclerView</strong>对象，通过它可以获取 item 的位置和 item 的 View，通过<code>parent.findViewHolderForAdapterPosition(firstCompleteVisibleIP)?.itemView</code>来获取 View 对象，这样可以根据想要操作的 Item 来定制化吸顶的效果。代码示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawOver</span><span class="params">(c: <span class="type">Canvas</span>, parent: <span class="type">RecyclerView</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 首先是分组的 Item 位置和内容，依靠这个 map 来维护</span></span><br><span class="line">   <span class="keyword">if</span> (indexMap.isNotEmpty()) &#123;</span><br><span class="line">     <span class="comment">// 找到第一个完全可见的 Item,这个是用来实现吸顶时的效果</span></span><br><span class="line">     <span class="keyword">val</span> firstCompleteVisibleIP =</span><br><span class="line">       (parent.layoutManager <span class="keyword">as</span> GridLayoutManager).findFirstCompletelyVisibleItemPosition()</span><br><span class="line">     <span class="comment">// 找到第一个可见的 Item，这个用来确定吸顶的文本显示</span></span><br><span class="line">     <span class="keyword">val</span> firstVisibleIP =</span><br><span class="line">       (parent.layoutManager <span class="keyword">as</span> GridLayoutManager).findFirstCompletelyVisibleItemPosition()</span><br><span class="line">     <span class="comment">// 根据firstCompleteVisibleIP获取到完全可见的 Item 的 view 对象</span></span><br><span class="line">     <span class="keyword">val</span> firstCompleteVisibleItemView =</span><br><span class="line">       parent.findViewHolderForAdapterPosition(firstCompleteVisibleIP)?.itemView</span><br><span class="line">     <span class="comment">// 这个 bottom 是吸顶的内容的高度</span></span><br><span class="line">     <span class="keyword">val</span> bottom = <span class="keyword">when</span> &#123;</span><br><span class="line">       <span class="comment">// 如果完全可见的 Item 是分组的 Item的时候,即进行吸顶效果的切换的时候，下一个分组顶掉了上一个分组的切换效果</span></span><br><span class="line">       indexMap.keys.contains(firstCompleteVisibleIP) -&gt; &#123;</span><br><span class="line">         <span class="comment">// 当完全可见的 Item 的 top 为0时，说明切换效果已经结束了，这个时候，吸顶显示的应该是下一个（相对于吸顶效果切换时）分组的内容 </span></span><br><span class="line">         <span class="keyword">if</span> (firstCompleteVisibleItemView?.top == <span class="number">0</span>) &#123;</span><br><span class="line">           itemHeaderHeight</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 吸顶切换进行的时候，不断的改变吸顶内容的高度来实现切换的效果，高度根据第一个完全可见的 view 的 top 来决定（这个时候第一个完全可见的 View 应该是下一个分组的 Item）</span></span><br><span class="line">           min(</span><br><span class="line">             itemHeaderHeight,</span><br><span class="line">             firstCompleteVisibleItemView?.top ?: itemHeaderHeight</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> -&gt; itemHeaderHeight</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 这里的逻辑是，根据第一个可见的 Item来寻找距离它最近的前一个分组 Item 的位置和后一个的位置</span></span><br><span class="line">     <span class="comment">// 主要用于前一个，因为上面的逻辑，在回调过程中，firstCompleteVisibleItemView.top 的值不是每一次都会回调，也就是 == 0的条件不一定能触发，所以不能根据上面的逻辑来觉得切换是否已经完成</span></span><br><span class="line">     <span class="comment">// 下面找到的 Item位置能保证当切换完成时找到的是位置就是本身，未完成时，找的都是上一个分组位置</span></span><br><span class="line">     <span class="keyword">val</span> lastAndNextTitle = findLastAndNextTitlePositionOfCurrentItem(firstVisibleIP)</span><br><span class="line">     titleStr = indexMap[lastAndNextTitle.first]</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 最后就是绘制了</span></span><br><span class="line">     titleStr?.let &#123; title -&gt;</span><br><span class="line">       c.drawRect(</span><br><span class="line">         <span class="number">0F</span>,</span><br><span class="line">         <span class="number">0F</span>,</span><br><span class="line">         parent.width.toFloat(),</span><br><span class="line">         bottom.toFloat(),</span><br><span class="line">         itemHeaderBackGroundPaint</span><br><span class="line">       )</span><br><span class="line">       c.drawText(</span><br><span class="line">         title,</span><br><span class="line">         SizeUtils.dp2px(<span class="number">16F</span>).toFloat(),</span><br><span class="line">         <span class="comment">// android text的绘制参考文章：https://hencoder.com/ui-1-3/</span></span><br><span class="line">         bottom - itemHeaderHeight / <span class="number">2</span> + (textPaint.fontMetrics.bottom - textPaint.fontMetrics.top) / <span class="number">2</span> - textPaint.fontMetrics.bottom,</span><br><span class="line">         textPaint</span><br><span class="line">       )</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h3 id="日期得计算"><a href="#日期得计算" class="headerlink" title="日期得计算"></a>日期得计算</h3><p>Date获取年份、月份和日期得方法已经被废弃了，现在获取需要使用<code>Calendar</code>类，具体如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> cal = Calendar.getInstance()</span><br><span class="line">cal.time = curDate <span class="comment">// Date 对象</span></span><br><span class="line"><span class="keyword">val</span> curYear = cal.<span class="keyword">get</span>(Calendar.YEAR)</span><br><span class="line"><span class="comment">// 月份需要加1</span></span><br><span class="line"><span class="keyword">val</span> curMonth = cal.<span class="keyword">get</span>(Calendar.MONTH) + <span class="number">1</span></span><br><span class="line"><span class="comment">// 这个月得第几天</span></span><br><span class="line"><span class="comment">// 还有方法可以获取今年的第几天</span></span><br><span class="line"><span class="keyword">val</span> curDay = cal.<span class="keyword">get</span>(Calendar.DAY_OF_MONTH)</span><br><span class="line"><span class="comment">// 本月的第几周</span></span><br><span class="line"><span class="keyword">val</span> weekOfMonth = cal.<span class="keyword">get</span>(Calendar.WEEK_OF_MONTH)</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-03-x2F-19"><a href="#2020-x2F-03-x2F-19" class="headerlink" title="2020&#x2F;03&#x2F;19"></a>2020&#x2F;03&#x2F;19</h2><h3 id="关于-ImageFilterView-中圆角的计算公式"><a href="#关于-ImageFilterView-中圆角的计算公式" class="headerlink" title="关于 ImageFilterView 中圆角的计算公式"></a>关于 ImageFilterView 中圆角的计算公式</h3><p>从源码中知道<code>ImageFilterView</code>是这样计算圆角的，所以拿到设计稿的 dp 时，反推就知道该设置多少的<code>roundPercent</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="variable">r</span> <span class="operator">=</span> (<span class="type">float</span>)Math.min(w, h) * ImageFilterView.<span class="built_in">this</span>.mRoundPercent / <span class="number">2.0F</span>;</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-03-x2F-23"><a href="#2020-x2F-03-x2F-23" class="headerlink" title="2020&#x2F;03&#x2F;23"></a>2020&#x2F;03&#x2F;23</h2><h3 id="关于-CoordinatorLayout-和-MotionLayout-结合使用的简单总结"><a href="#关于-CoordinatorLayout-和-MotionLayout-结合使用的简单总结" class="headerlink" title="关于 CoordinatorLayout 和 MotionLayout 结合使用的简单总结"></a>关于 CoordinatorLayout 和 MotionLayout 结合使用的简单总结</h3><p>需求是实现一个个人主页，吸顶加列表的样式，那么整个 xml 的结构如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- CoordinatorLayout</span><br><span class="line">		-- AppBarLayout</span><br><span class="line">				-- CollapsibleToolbar</span><br><span class="line">		-- Content</span><br></pre></td></tr></table></figure>

<p>坑记:</p>
<ul>
<li><p>需要<code>Content</code>随着<code>AppBarLayout</code>移动，需要在<code>Content</code>的 xml 中的顶级 View 设置<code>app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot;</code>属性，其值为：<code>&lt;string name=&quot;appbar_scrolling_view_behavior&quot; translatable=&quot;false&quot;&gt;android.support.design.widget.AppBarLayout$ScrollingViewBehavior&lt;/string&gt;</code></p>
<p>如果需要更复杂的滑动联动效果，就需要自己自定义这个 <code>behavior</code> 了</p>
</li>
<li><p>如果需要去除<code>AppBarLayout 的阴影</code>，需要设置<code>app:elevation=&quot;0dp&quot;</code>使用的是<code>app</code>而不是<code>android </code></p>
</li>
<li><p>如果<code>Content</code>中存在列表，设置联动的形式，可以设置CollapsibleToolbar 的<code>app:layout_scrollFlags=&quot;scroll|exitUntilCollapsed&quot;</code>这个属性的几个标签详解：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7caa5f4f49bd">Android 详细分析AppBarLayout的五种ScrollFlags</a></p>
</li>
</ul>
<h2 id="2020-x2F-03-x2F-28"><a href="#2020-x2F-03-x2F-28" class="headerlink" title="2020&#x2F;03&#x2F;28"></a>2020&#x2F;03&#x2F;28</h2><h3 id="关于使用-MotionLayou实现个人的顶部吸顶效果"><a href="#关于使用-MotionLayou实现个人的顶部吸顶效果" class="headerlink" title="关于使用 MotionLayou实现个人的顶部吸顶效果"></a>关于使用 MotionLayou实现个人的顶部吸顶效果</h3><p>目前采用的改变单一一个 view 控件在初始状态和终止状态约束的不同，然后由代码进行控制，动态设置背景的高度，静态 xml 的布局如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.motion.widget.MotionLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/motionLayout&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:layoutDescription</span>=<span class="string">&quot;@xml/scene_03_2&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MotionActivity&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:id</span>=<span class="string">&quot;@+id/bgCover&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_height</span>=<span class="string">&quot;200dp&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:background</span>=<span class="string">&quot;@drawable/google_plex_cover&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:contentDescription</span>=<span class="string">&quot;@null&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:id</span>=<span class="string">&quot;@+id/headerTv&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_height</span>=<span class="string">&quot;300dp&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:background</span>=<span class="string">&quot;@color/colorPrimaryDark90&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:text</span>=<span class="string">&quot;我是顶部信息&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:textColor</span>=<span class="string">&quot;#fff&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:textSize</span>=<span class="string">&quot;32sp&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span></span></span><br><span class="line"><span class="tag">      <span class="attr">layout</span>=<span class="string">&quot;@layout/content_scrolling&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:id</span>=<span class="string">&quot;@+id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_height</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:background</span>=<span class="string">&quot;@color/colorAccent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:text</span>=<span class="string">&quot;我是状态栏&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:textColor</span>=<span class="string">&quot;#000&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:id</span>=<span class="string">&quot;@+id/navTv&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_height</span>=<span class="string">&quot;44dp&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:background</span>=<span class="string">&quot;@color/colorAccent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:text</span>=<span class="string">&quot;我是导航栏&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:textColor</span>=<span class="string">&quot;#fff&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:textSize</span>=<span class="string">&quot;18sp&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.motion.widget.MotionLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的 scene 描述文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">MotionScene</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:motion</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Transition</span></span></span><br><span class="line"><span class="tag">      <span class="attr">motion:constraintSetEnd</span>=<span class="string">&quot;@id/end&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">motion:constraintSetStart</span>=<span class="string">&quot;@id/start&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">motion:duration</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnSwipe</span></span></span><br><span class="line"><span class="tag">        <span class="attr">motion:dragDirection</span>=<span class="string">&quot;dragUp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">motion:touchAnchorId</span>=<span class="string">&quot;@+id/bgCover&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">motion:touchAnchorSide</span>=<span class="string">&quot;bottom&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">KeyFrameSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">KeyAttribute</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:alpha</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:framePosition</span>=<span class="string">&quot;70&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:motionTarget</span>=<span class="string">&quot;@id/headerTv&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">KeyAttribute</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:alpha</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:framePosition</span>=<span class="string">&quot;70&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:motionTarget</span>=<span class="string">&quot;@id/bgCover&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">KeyAttribute</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:alpha</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:framePosition</span>=<span class="string">&quot;70&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:motionTarget</span>=<span class="string">&quot;@id/statusView&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">KeyAttribute</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:alpha</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:framePosition</span>=<span class="string">&quot;70&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">motion:motionTarget</span>=<span class="string">&quot;@id/navTv&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">KeyFrameSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Transition</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ConstraintSet</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/start&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/bgCover&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/headerTv&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;300dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@id/headerTv&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;1dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;0.7&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/navTv&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;44dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ConstraintSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ConstraintSet</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/end&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/bgCover&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/headerTv&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;300dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/scrollable&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@id/navTv&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;1dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Constraint</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/navTv&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;44dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@id/statusView&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ConstraintSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">MotionScene</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个描述文件中，主要操作是改变了底部可滑动布局在不同状态的约束，开始时，约束于顶部的 header 信息布局，这样能保证信息的完整显示，在终态下，需要吸顶顶部的导航栏。动画效果具体的控制则是由<code>KeyFrameSet</code>控制。</p>
<p>背景图片的大小和状态栏的适配，需要在代码中获取到状态栏的高度后，再去更新相应的约束</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> statusBarH = Resources.getSystem()</span><br><span class="line">      .getDimensionPixelSize(resources.getIdentifier(<span class="string">&quot;status_bar_height&quot;</span>, <span class="string">&quot;dimen&quot;</span>, <span class="string">&quot;android&quot;</span>))</span><br><span class="line">    scrollable.postDelayed(&#123;</span><br><span class="line">      motionLayout.getConstraintSet(R.id.start)?.let &#123; <span class="keyword">set</span> -&gt;</span><br><span class="line">        <span class="keyword">set</span>.constrainHeight(R.id.statusView, statusBarH)</span><br><span class="line">        <span class="keyword">set</span>.constrainHeight(R.id.bgCover, statusBarH + headerTv.height)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      motionLayout.getConstraintSet(R.id.end)?.let &#123; <span class="keyword">set</span> -&gt;</span><br><span class="line">        <span class="keyword">set</span>.constrainHeight(R.id.statusView, statusBarH)</span><br><span class="line">        <span class="keyword">set</span>.constrainHeight(R.id.bgCover, statusBarH + headerTv.height)</span><br><span class="line">      &#125;</span><br><span class="line">      motionLayout.requestLayout()</span><br><span class="line">    &#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-04-x2F-07"><a href="#2020-x2F-04-x2F-07" class="headerlink" title="2020&#x2F;04&#x2F;07"></a>2020&#x2F;04&#x2F;07</h2><h3 id="关于-Kotlin-中的函数引用多个参数时的用法"><a href="#关于-Kotlin-中的函数引用多个参数时的用法" class="headerlink" title="关于 Kotlin 中的函数引用多个参数时的用法"></a>关于 Kotlin 中的函数引用多个参数时的用法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">testFunReference</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> result = (::func)(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">  println((::func)(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">func</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-04-x2F-20"><a href="#2020-x2F-04-x2F-20" class="headerlink" title="2020&#x2F;04&#x2F;20"></a>2020&#x2F;04&#x2F;20</h2><h3 id="聊天页面的LayoutManager优化"><a href="#聊天页面的LayoutManager优化" class="headerlink" title="聊天页面的LayoutManager优化"></a>聊天页面的LayoutManager优化</h3><blockquote>
<p>需求：聊天页面中是最新的在底部显示，但是没有达到一屏的依然会显示在顶部，所以只有重新写 layoutManager来动态适配这样的规则，在搜索了一番后，发现 LinearLayoutManager 中有一个 onAnchorReady 的空方法提供给开发者扩展</p>
</blockquote>
<p>通过查看源码发现，<code>linearlayoutmanager</code>中主要通过<code>AnchorInfo</code>的辅助类来实现<code>item</code>的布局的起点位置和方向。在<code>layoutChildren</code>的方法中，开始调用真正布局的<code>fill</code>方法之前会先回调<code>onAnchorReady</code>方法。所以我的思路是可以重写这个方法，修改<code>anchorInfo</code>变量中的位置信息达到动态改变布局方向的要求。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnchorReady</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    recycler: <span class="type">RecyclerView</span>.<span class="type">Recycler</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    state: <span class="type">RecyclerView</span>.<span class="type">State</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchorInfo: <span class="type">AnchorInfo</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    firstLayoutItemDirection: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (recycler != <span class="literal">null</span> &amp;&amp; anchorInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">      detachAndScrapAttachedViews(recycler)</span><br><span class="line">      <span class="keyword">var</span> totalHeight = <span class="number">0</span></span><br><span class="line">      <span class="keyword">for</span> (position <span class="keyword">in</span> <span class="number">0</span> until itemCount) &#123;</span><br><span class="line">        <span class="keyword">val</span> view = recycler.getViewForPosition(position)</span><br><span class="line">        measureChild(view, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        totalHeight += getDecoratedMeasuredHeight(view)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (totalHeight != <span class="number">0</span> &amp;&amp; maxHeightForRecyclerView != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (totalHeight &gt; maxHeightForRecyclerView) &#123;</span><br><span class="line">          anchorInfo.mLayoutFromEnd = <span class="literal">true</span></span><br><span class="line">          anchorInfo.mPosition = itemCount - <span class="number">1</span></span><br><span class="line">          setStackFromEndByUser = <span class="literal">false</span></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 调用[LinearLayoutManager.setStackFromEnd]这个方法时，会调用[assertNotInLayoutOrScroll] 和 [requestLayout]</span></span><br><span class="line"><span class="comment">           * 上面的方法重写，屏蔽了调用的逻辑，仅用于赋值</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          stackFromEnd = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中，通过<code>recycler</code>中拿到所有的<code>item</code>进行测量，并和从外传入的参数进行比较（因为最大的可展示高度应该是由外部决定的）。</p>
<p>但是仅这样处理发现并没有效果，追踪了代码发现在布局代码的后面还存在一个修正的方法，源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// changes may cause gaps on the UI, try to fix them.</span></span><br><span class="line"><span class="comment">// TODO we can probably avoid this if neither stackFromEnd/reverseLayout/RTL values have</span></span><br><span class="line"><span class="comment">// changed</span></span><br><span class="line"><span class="keyword">if</span> (getChildCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// because layout from end may be changed by scroll to position</span></span><br><span class="line">    <span class="comment">// we re-calculate it.</span></span><br><span class="line">    <span class="comment">// find which side we should check for gaps.</span></span><br><span class="line">    <span class="keyword">if</span> (mShouldReverseLayout ^ mStackFromEnd) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fixOffset</span> <span class="operator">=</span> fixLayoutEndGap(endOffset, recycler, state, <span class="literal">true</span>);</span><br><span class="line">        startOffset += fixOffset;</span><br><span class="line">        endOffset += fixOffset;</span><br><span class="line">        fixOffset = fixLayoutStartGap(startOffset, recycler, state, <span class="literal">false</span>);</span><br><span class="line">        startOffset += fixOffset;</span><br><span class="line">        endOffset += fixOffset;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fixOffset</span> <span class="operator">=</span> fixLayoutStartGap(startOffset, recycler, state, <span class="literal">true</span>);</span><br><span class="line">        startOffset += fixOffset;</span><br><span class="line">        endOffset += fixOffset;</span><br><span class="line">        fixOffset = fixLayoutEndGap(endOffset, recycler, state, <span class="literal">false</span>);</span><br><span class="line">        startOffset += fixOffset;</span><br><span class="line">        endOffset += fixOffset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它依然会根据<code>mStackFromEnd</code>这个变量的值来动态修正。所以导致我们改变的锚点信息没有用（这个变量的赋值在代码中除了手动设置以外，也是由<code>anchorInfo</code>的变量得出来的）</p>
<p>所以在修改<code>anchorInfo</code>的同时，还需要修改这个变量。带来的另一个问题是，这个变量的 <code>set</code>方法时，会检查当前的状态是否是正在<code>layout</code>，会调用<code>requestLayout()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Compatibility support for &#123;<span class="doctag">@link</span> android.widget.AbsListView#setStackFromBottom(boolean)&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStackFromEnd</span><span class="params">(<span class="type">boolean</span> stackFromEnd)</span> &#123;</span><br><span class="line">		<span class="comment">// 这个方法会检查是否处于滚动或者布局中</span></span><br><span class="line">    assertNotInLayoutOrScroll(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (mStackFromEnd == stackFromEnd) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mStackFromEnd = stackFromEnd;</span><br><span class="line">    <span class="comment">// 重新布局</span></span><br><span class="line">    requestLayout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们想要的，仅仅是修改<code>mStackFromEnd</code>这个变量的值。所以在我们的代码里，重写了这两个方法，如果是因为我们的测量而手动设置<code>mStatckFromEnd</code>时，上面的两个方法都不需要调用。完整的代码如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因为 anchorInfo 方法的可见性为 default(对应 kotlin 中的 internal)，所以需要同包名</span></span><br><span class="line"><span class="keyword">package</span> androidx.recyclerview.widget</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * description: 适配了聊天页面布局的 layoutmanager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020-04-15 17:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Grieey</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ChatLayoutManager</span>(context: Context) : LinearLayoutManager(context) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> isAnchorInfoHandled = <span class="literal">false</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个标识用于处理动态修改 stackFromEnd ，取消调用requestLayout</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> setStackFromEndByUser = <span class="literal">true</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个值是用于判断是否需要修改 setStackFromEnd 属性</span></span><br><span class="line"><span class="comment">   * 当测量的 item 高度大于该值的时候，才需要动态的修改</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> maxHeightForRecyclerView: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * setStackFromEnd 方法中，会调用这个方法进行检查，由我们自己处理这个赋值的时候，屏蔽调用</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">assertNotInLayoutOrScroll</span><span class="params">(message: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (setStackFromEndByUser) &#123;</span><br><span class="line">      <span class="keyword">super</span>.assertNotInLayoutOrScroll(message)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 重写方法作用同理上面</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestLayout</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (setStackFromEndByUser) &#123;</span><br><span class="line">      <span class="keyword">super</span>.requestLayout()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setStackFromEndByUser = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnchorReady</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    recycler: <span class="type">RecyclerView</span>.<span class="type">Recycler</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    state: <span class="type">RecyclerView</span>.<span class="type">State</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchorInfo: <span class="type">AnchorInfo</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    firstLayoutItemDirection: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (recycler != <span class="literal">null</span> &amp;&amp; anchorInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">      detachAndScrapAttachedViews(recycler)</span><br><span class="line">      <span class="keyword">var</span> totalHeight = <span class="number">0</span></span><br><span class="line">      <span class="keyword">for</span> (position <span class="keyword">in</span> <span class="number">0</span> until itemCount) &#123;</span><br><span class="line">        <span class="keyword">val</span> view = recycler.getViewForPosition(position)</span><br><span class="line">        measureChild(view, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        totalHeight += getDecoratedMeasuredHeight(view)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (totalHeight != <span class="number">0</span> &amp;&amp; maxHeightForRecyclerView != <span class="number">0</span> &amp;&amp; !isAnchorInfoHandled) &#123;</span><br><span class="line">        <span class="keyword">if</span> (totalHeight &gt; maxHeightForRecyclerView) &#123;</span><br><span class="line">          anchorInfo.mLayoutFromEnd = <span class="literal">true</span></span><br><span class="line">          anchorInfo.mPosition = itemCount - <span class="number">1</span></span><br><span class="line">          setStackFromEndByUser = <span class="literal">false</span></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 调用[LinearLayoutManager.setStackFromEnd]这个方法时，会调用[assertNotInLayoutOrScroll] 和 [requestLayout]</span></span><br><span class="line"><span class="comment">           * 上面的方法重写，屏蔽了调用的逻辑，仅用于赋值</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          stackFromEnd = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-04-x2F-22"><a href="#2020-x2F-04-x2F-22" class="headerlink" title="2020&#x2F;04&#x2F;22"></a>2020&#x2F;04&#x2F;22</h2><h3 id="kotlin中的函数引用多参数使用"><a href="#kotlin中的函数引用多参数使用" class="headerlink" title="kotlin中的函数引用多参数使用"></a>kotlin中的函数引用多参数使用</h3><p>对于<code>kotlin</code>中函数引用的更多用于，如果只是一个参数，像之前那样使用就可以了，如果存在多个函数呢，并且存在返回值，比如以下这样的场景</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">safe</span><span class="params">(a:<span class="type">Int</span>?, b:<span class="type">Int</span>?, block:(<span class="type">a</span>:<span class="type">Int</span>, <span class="type">b</span>:<span class="type">Int</span> ) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (a != <span class="literal">null</span> &amp;&amp; b != <span class="literal">null</span>) &#123;</span><br><span class="line">		block(a, b)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用时</span></span><br><span class="line">safe(a, b)&#123; a1, b1 -&gt; </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样其实也没有问题，但是可以有更优雅的写法，那就是利用函数引用。我们可以看看，后面的<code>block</code>本质上是一个高阶函数，高阶函数其实是一个函数对象。而函数引用，本质上也是将引用指向一个具有和函数功能相同的对象。这个有点抽象，从实际的例子中看看，首先看怎么用的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个和block一样功能的函数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">function</span><span class="params">(a:<span class="type">Int</span>, b:<span class="type">Int</span>)</span></span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用时</span></span><br><span class="line">safe(a, b, ::function)</span><br></pre></td></tr></table></figure>

<p>因为这个<code>function</code>的函数接收两个参数，而<code>block</code>这个高阶函数，也需要接收两个参数，但是在这里，他们是两个东西，一个是函数，一个是函数类型的对象，那么怎么把函数变成函数类型的对象呢，使用**:: ** 就可以将一个函数变成具有和函数功能一样的对象了，这就是函数引用。也就是说<code>::function</code>这样操作后，和<code>block</code>是一样的类型了。</p>
<h2 id="2020-x2F-04-x2F-27"><a href="#2020-x2F-04-x2F-27" class="headerlink" title="2020&#x2F;04&#x2F;27"></a>2020&#x2F;04&#x2F;27</h2><h3 id="两个文本的自适应省略布局"><a href="#两个文本的自适应省略布局" class="headerlink" title="两个文本的自适应省略布局"></a>两个文本的自适应省略布局</h3><blockquote>
<p>UI的一个需求，显示两个文本，文本的宽度都是自适应，但是当两个文本宽度加起来达到最大时，有不同的表现：</p>
<p>1.如果两个文本都超长，则都显示省略号</p>
<p>2.如果一个超长，一个很短，那么短的完整显示，长的省略显示</p>
</blockquote>
<p>这里我们用于设置文本的控件是一个自定义控件，内部持有一个<code>textView</code>,所以如果只是简单的将控件的宽度设置为<code>wrap_content</code>的话，后面一个的显示会导致前面的文本被挤压。开始尝试了使用<code>LinearLayout</code>和<code>ConstrainLayout</code>，但是两个文本控件的宽度都设置为<code>wrap_content</code>时，父控件在<code>onMeasure</code>其实都是无法根据现有的约束来设置文本控件中的<code>textView</code>是否需要省略的。</p>
<p>所以我采取了反向思维，父布局使用<code>LinearLayout</code>，将两个文本控件按照比重平分，然后在代码中，获取文本控件的<code>textView</code>判断是否达到了省略，如果没有，重新设置文本控件的属性为<code>warap_content</code>，这样根据已经计算好的结果可以重新设置一次。比较耗费性能的就是需要重新<code>requestLayout</code>一次。xml代码就不贴了，就是线性布局中，两个自定义的文本控件按照比重平分。主要是代码部分的设置： </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重新布局，根据是否省略来重置tagView的属性</span></span><br><span class="line">view.postDelayed(&#123;</span><br><span class="line">  <span class="keyword">val</span> childCount = view.childCount</span><br><span class="line">  <span class="keyword">for</span> (index <span class="keyword">in</span> <span class="number">0</span> until childCount) &#123;</span><br><span class="line">    <span class="keyword">val</span> tagView = view.getChildAt(index)</span><br><span class="line">    <span class="keyword">if</span> (tagView <span class="keyword">is</span> TagView) &#123;</span><br><span class="line">      <span class="comment">// isEllisped 方法就是获取textView的layout，然后调用getEllipsisCount获取省略字数</span></span><br><span class="line">      <span class="keyword">if</span> (!tagView.isEllipsed()) &#123;</span><br><span class="line">        tagView.layoutParams?.let &#123;</span><br><span class="line">          (it <span class="keyword">as</span>? LinearLayout.LayoutParams)?.weight = <span class="number">0F</span></span><br><span class="line">          (it <span class="keyword">as</span>? LinearLayout.LayoutParams)?.width = ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    view.commonItemFollowBotCircleLayout.requestLayout()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Travis-CI-安装指定版本的Node-js"><a href="#Travis-CI-安装指定版本的Node-js" class="headerlink" title="Travis CI 安装指定版本的Node.js"></a>Travis CI 安装指定版本的Node.js</h3><p>修改<code>.travis.yaml</code>文件中的配置:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">v10.16.0</span> <span class="string">//</span> <span class="string">要最新的就是</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-04-x2F-30"><a href="#2020-x2F-04-x2F-30" class="headerlink" title="2020&#x2F;04&#x2F;30"></a>2020&#x2F;04&#x2F;30</h2><p>###实现输入限制仅为中英文加数字和不同字符的计算</p>
<p>比较优雅的做法是给<code>editText</code>设置<code>filters</code>，进行过滤，这样能直接限制输入的回调。要限制为中英文的输入，和计算中英文中每个字符所占的个数的不同时，在<code>filters</code>中会比较轻易的实现。首先，对刚刚输入的字符串，进行过滤，这样能保证接下来的处理仅包含需要处理的字符串，这一步的操作通过正则表达式来实现。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> chinesePattern = Pattern.compile(<span class="string">&quot;[\u4e00-\u9fa5]+&quot;</span>) <span class="comment">// 判断中文</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> letterPattern = Pattern.compile(<span class="string">&quot;[a-zA-Z]+&quot;</span>) <span class="comment">// 判断英文大小写</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> numberPattern = Pattern.compile(<span class="string">&quot;[0-9]+&quot;</span>) <span class="comment">// 判断数字</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> findAll = Pattern.compile(<span class="string">&quot;[0-9a-zA-Z\u4e00-\u9fa5]+&quot;</span>) <span class="comment">// 判断上诉所有</span></span><br></pre></td></tr></table></figure>

<p>通过<code>findAll</code>先进行输入字符串的过滤</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> filterText = StringBuilder()</span><br><span class="line"><span class="keyword">val</span> findAllMatcher = findAll.matcher(source)</span><br><span class="line"><span class="keyword">while</span> (findAllMatcher.find()) &#123;</span><br><span class="line">  filterText.append(findAllMatcher.group())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>###自定义的GsonBuilder进行三方解析</p>
<p><code>gsonBuilder</code>可以进行自定义的<code>typeAdapter</code>注册，这样能够进行一些可见性受限制的类的序列化，主要使用的是<code>gson</code>中的<code>JsonSerializer</code>和<code>JsonDeserializer</code>这两个接口。通过实现他们，就能将自定义的类型进行 <code>toJson</code>和<code>fromJson</code>的操作了。这里使用一个实例来展示如何使用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextMessageSerializer</span> : <span class="type">JsonSerializer</span>&lt;<span class="type">ReEditMsgCacheBean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">serialize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    src: <span class="type">ReEditMsgCacheBean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    typeOfSrc: <span class="type">Type</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    context: <span class="type">JsonSerializationContext</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>: JsonElement &#123;</span><br><span class="line">    <span class="keyword">return</span> JsonPrimitive(src.toString())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ReEditMsgCacheBean</code>是我们自定义的类，里面包含一些三方库的实体，没有默认构造函数实现的时候。这个类就统一将整个对象转为<code>String</code>字符串。</p>
<p>接下来就是解析了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextMessageDeserializer</span> : <span class="type">JsonDeserializer</span>&lt;<span class="type">ReEditMsgCacheBean</span>&gt; &#123;</span><br><span class="line">  <span class="meta">@Throws(JsonParseException::class)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">deserialize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    src: <span class="type">JsonElement</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">    srcType: <span class="type">Type</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    context: <span class="type">JsonDeserializationContext</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>: ReEditMsgCacheBean &#123;</span><br><span class="line">    <span class="keyword">if</span> (src.isJsonObject) &#123;</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 不能使用src.get(&quot;recallMsg&quot;).asString 会抛出异常</span></span><br><span class="line">      <span class="comment">// 第三方库中的TextMessage类的对象没有暴露默认构造方法，所以需要在这里调用有参的构造方式实现</span></span><br><span class="line">      <span class="keyword">val</span> textMessage = TextMessage(src.<span class="keyword">get</span>(<span class="string">&quot;textMessage&quot;</span>).toString().toByteArray())</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> ReEditMsgCacheBean(textMessage)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReEditMsgCacheBean(TextMessage.obtain(<span class="string">&quot;&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2020-x2F-05-x2F-06"><a href="#2020-x2F-05-x2F-06" class="headerlink" title="2020&#x2F;05&#x2F;06"></a>2020&#x2F;05&#x2F;06</h2><h3 id="Mac下设置JDK环境"><a href="#Mac下设置JDK环境" class="headerlink" title="Mac下设置JDK环境"></a>Mac下设置JDK环境</h3><p>首先到<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase-jdk14-downloads.html">官网</a>下载对应<strong>Mac</strong>的<code>jdk</code>，下载后解压缩会得到一个文件夹。然后使用命令行工具打开编辑<code>~/.bash_profile</code>文件，如果没有就在<code>~/</code>目录下创建一个<code>touch .bash_profile</code>，输入以下的代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># JAVA_HOME的路径为刚刚解压的压缩包路径，到Home文件夹这一层</span></span></span><br><span class="line">export JAVA_HOME=/Users/griee/Documents/Workspace/JavaPro/JDK/jdk-14.0.1.jdk/Contents/Home</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br></pre></td></tr></table></figure>

<p>然后执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br><span class="line">java --version</span><br></pre></td></tr></table></figure>

<p>来检查是否配置正确。</p>
<h2 id="2020-x2F-05-x2F-07"><a href="#2020-x2F-05-x2F-07" class="headerlink" title="2020&#x2F;05&#x2F;07"></a>2020&#x2F;05&#x2F;07</h2><h3 id="背景高亮渐变的动画设置"><a href="#背景高亮渐变的动画设置" class="headerlink" title="背景高亮渐变的动画设置"></a>背景高亮渐变的动画设置</h3><p>很多时候需要背景高亮然后颜色渐变显示，使用<code>ArgbEvaluator()</code>的插值器</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> evaluator = ArgbEvaluator()</span><br><span class="line">animator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>)</span><br><span class="line"><span class="keyword">val</span> startColor = Color.parseColor(<span class="string">&quot;#FF31D18B&quot;</span>)</span><br><span class="line">animator?.addUpdateListener &#123;</span><br><span class="line">  <span class="keyword">val</span> value: <span class="built_in">Float</span> = it.animatedValue <span class="keyword">as</span> <span class="built_in">Float</span></span><br><span class="line">  <span class="keyword">if</span> (value == <span class="number">1f</span>) &#123;</span><br><span class="line">    view?.setBackgroundColor(Color.TRANSPARENT)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    view?.setBackgroundColor(evaluator.evaluate(value, startColor, Color.TRANSPARENT) <span class="keyword">as</span> <span class="built_in">Int</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">animator?.interpolator = LinearInterpolator()</span><br><span class="line">animator?.duration = <span class="number">3000</span></span><br><span class="line">animator?.start()</span><br></pre></td></tr></table></figure>



<h3 id="透明度表格"><a href="#透明度表格" class="headerlink" title="透明度表格"></a>透明度表格</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hewuzhao/article/details/78821954">最全的Android 颜色透明度</a></p>
<h2 id="2020-x2F-05-x2F-11"><a href="#2020-x2F-05-x2F-11" class="headerlink" title="2020&#x2F;05&#x2F;11"></a>2020&#x2F;05&#x2F;11</h2><h3 id="关于equals-和-x3D-x3D"><a href="#关于equals-和-x3D-x3D" class="headerlink" title="关于equals()和&#x3D;&#x3D;"></a>关于equals()和&#x3D;&#x3D;</h3><h4 id="Java中"><a href="#Java中" class="headerlink" title="Java中"></a>Java中</h4><p>首先明确，在<strong>Java</strong>中，<code>==</code>比较的是对象的首地址，而<code>equals</code>是&#96;Object的方法，比较的也是首地址，但是很多类对这个方法进行了重写，就可以是比较的内容，比如<strong>String</strong>类。示例如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">str1 == str2; <span class="comment">// false, 对象的首地址不一样</span></span><br><span class="line">str1.equals(str2); <span class="comment">// true,对象的内容是一样的</span></span><br><span class="line">  </span><br><span class="line"><span class="type">StringBuffer</span> <span class="variable">sb1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="type">StringBuffer</span> <span class="variable">sb2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">sb1 == sb2; <span class="comment">// false, 对象的首地址不一样</span></span><br><span class="line">sb1.equals(sb2); <span class="comment">// false, 因为StringBuffer类没有重新Object的Equals方法，所以比较的是首地址</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 特殊情况1</span></span><br><span class="line"><span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">str3 == str4; <span class="comment">// true, 因为str3 和str4 是由字符串常量生成的变量，他们指向的首地址是同一个，所以相等</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 特殊情况2</span></span><br><span class="line"><span class="comment">// 基本类型只能用 == 比较，而且比较的是值</span></span><br><span class="line"><span class="comment">// 如果是基本类型的包装类型，那么如同String类</span></span><br><span class="line"><span class="type">int</span> <span class="variable">num1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">num2</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">num3</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">num1 == num2; <span class="comment">// false</span></span><br><span class="line">num1 == num3; <span class="comment">// true</span></span><br><span class="line">num1.equals(num2); <span class="comment">// error </span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bluestorm/archive/2012/03/02/2377615.html">java中equals方法的用法以及&#x3D;&#x3D;的用法</a></p>
<h3 id="Kotlin"><a href="#Kotlin" class="headerlink" title="Kotlin"></a>Kotlin</h3><p>在<strong>Kotlin</strong>中，<code>==</code> 为<code>equals()</code>方法，而<code>===</code> 等于<strong>Java</strong>中的<code>==</code>。</p>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>上述示例中的特殊情况1是因为有字符串常量生成的变量，字符串常量是<code>JVM</code>为了减少频繁创建字符串带来的性能销毁所所做的缓存。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> str1 = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line"><span class="keyword">val</span> str2 = <span class="string">&quot;Hello&quot;</span></span><br><span class="line"><span class="keyword">val</span> str3 = <span class="string">&quot;World&quot;</span></span><br><span class="line"><span class="keyword">val</span> str4 = str2 + str3</span><br><span class="line"><span class="keyword">val</span> str5 = <span class="string">&quot;Hello&quot;</span> + <span class="string">&quot;World&quot;</span></span><br><span class="line"></span><br><span class="line">str1 == str4 <span class="comment">// true</span></span><br><span class="line">str1 === str4 <span class="comment">// false</span></span><br><span class="line">str1 === str5 <span class="comment">// true , JVM 在编译时，会优化 &quot;Hello&quot; + &quot;World&quot;操作，合并为&quot;HelloWorld&quot;</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://www.iteye.com/blog/rednaxelafx-774673">关于String a &#x3D; String(“xyz”)创建了多少个对象的讨论</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/q5706503/article/details/84640762">JDK1.8之后的运行时常量池</a></p>
<h2 id="2020-x2F-06-x2F-01"><a href="#2020-x2F-06-x2F-01" class="headerlink" title="2020&#x2F;06&#x2F;01"></a>2020&#x2F;06&#x2F;01</h2><h3 id="Android-Studio-4-0-无法运行debug包的报错处理"><a href="#Android-Studio-4-0-无法运行debug包的报错处理" class="headerlink" title="Android Studio 4.0 无法运行debug包的报错处理"></a>Android Studio 4.0 无法运行debug包的报错处理</h3><p>在<code>gradle.properties</code>中添加</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.injected.testOnly=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="Android-报错1-1-8生成的字节码无法内联到1-1-6生成的字节码中"><a href="#Android-报错1-1-8生成的字节码无法内联到1-1-6生成的字节码中" class="headerlink" title="Android 报错1.1.8生成的字节码无法内联到1.1.6生成的字节码中"></a>Android 报错1.1.8生成的字节码无法内联到1.1.6生成的字节码中</h3><p>解决方案是在AndroidConfig中添加jvm相关的参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kotlinOptions &#123;</span><br><span class="line">    jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还需要在AndroidStudio中修改项目的编译<strong>JDK</strong>版本为<code>1.1.8</code></p>
<h2 id="2020-x2F-06-x2F-27"><a href="#2020-x2F-06-x2F-27" class="headerlink" title="2020&#x2F;06&#x2F;27"></a>2020&#x2F;06&#x2F;27</h2><h3 id="Mac上使用MAT分析内存"><a href="#Mac上使用MAT分析内存" class="headerlink" title="Mac上使用MAT分析内存"></a>Mac上使用MAT分析内存</h3><p>首先在官网上下载工具<a href="%5Bhttps://www.eclipse.org/mat/downloads.php%5D(https:/eclipse.org/mat/%5D(https://www.eclipse.org/mat/downloads.php%5D(https:/eclipse.org/mat/)">传送门</a>。</p>
<p>该工具官网说最低需要<strong>JDK1.8</strong>的支持，所以需要在mac上安装<strong>JDK1.8</strong>的环境，网上下载好<strong>JDK1.8</strong>安装好就可以了，使用<code>java -version</code>命令来验证是否安装成功。</p>
<p>使用<strong>MAT</strong>工具需要打开app的包内容，到里面的<code>/MacOs</code>目录下手动开启工具。从<strong>AndroidStudio</strong>的<strong>Profiler</strong>中直接导出的hprof文件是不能直接使用的，需要到Android的<code>/SDK/platform-tools/</code>目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hprof-conv /Users/griee/Desktop/Log/profs/5.hprof /Users/griee/Desktop/Log/profs/5-new.hprof</span><br></pre></td></tr></table></figure>

<p>来进行转换，前面是刚刚从<strong>Profiler</strong>中导出的文件地址，后面是需要导出的文件地址</p>
<h2 id="2020-x2F-09-x2F-07"><a href="#2020-x2F-09-x2F-07" class="headerlink" title="2020&#x2F;09&#x2F;07"></a>2020&#x2F;09&#x2F;07</h2><h3 id="关于Paint中getFontMetrics方法所获取的数据"><a href="#关于Paint中getFontMetrics方法所获取的数据" class="headerlink" title="关于Paint中getFontMetrics方法所获取的数据"></a>关于Paint中getFontMetrics方法所获取的数据</h3><p>这个方法最后调用的是native层中的方法进行测量的， <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/master/core/jni/android/graphics/Paint.cpp">在线地址</a></p>
<p>首先是Java层的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the font&#x27;s recommended interline spacing, given the Paint&#x27;s</span></span><br><span class="line"><span class="comment"> * settings for typeface, textSize, etc. If metrics is not null, return the</span></span><br><span class="line"><span class="comment"> * fontmetric values in it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note that these are the values for the main typeface, and actual text rendered may need a</span></span><br><span class="line"><span class="comment"> * larger set of values because fallback fonts may get used in rendering the text.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> metrics If this object is not null, its fields are filled with</span></span><br><span class="line"><span class="comment"> *                the appropriate values given the paint&#x27;s text attributes.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the font&#x27;s recommended interline spacing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getFontMetrics</span><span class="params">(FontMetrics metrics)</span> &#123;</span><br><span class="line">   <span class="comment">// 直接调用的native </span></span><br><span class="line">    <span class="keyword">return</span> nGetFontMetrics(mNativePaint, metrics);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是native中对应的方法，会先去根据传入的Paint对象来获取文字相关的数据，再把计算的数据设置到java层刚刚传入的<code>metrics</code>对象中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> jfloat <span class="title">getFontMetrics</span><span class="params">(JNIEnv* env, jobject, jlong paintHandle, jobject metricsObj)</span> </span>&#123;</span><br><span class="line">    SkFontMetrics metrics;</span><br><span class="line">    <span class="comment">// 在这里获取具体的数据</span></span><br><span class="line">    SkScalar spacing = <span class="built_in">getMetricsInternal</span>(paintHandle, &amp;metrics);</span><br><span class="line">   <span class="comment">// 将测量出来的数据赋值给java</span></span><br><span class="line">    <span class="keyword">if</span> (metricsObj) &#123;</span><br><span class="line">        <span class="built_in">SkASSERT</span>(env-&gt;<span class="built_in">IsInstanceOf</span>(metricsObj, gFontMetrics_class));</span><br><span class="line">        env-&gt;<span class="built_in">SetFloatField</span>(metricsObj, gFontMetrics_fieldID.top, <span class="built_in">SkScalarToFloat</span>(metrics.fTop));</span><br><span class="line">        env-&gt;<span class="built_in">SetFloatField</span>(metricsObj, gFontMetrics_fieldID.ascent, <span class="built_in">SkScalarToFloat</span>(metrics.fAscent));</span><br><span class="line">        env-&gt;<span class="built_in">SetFloatField</span>(metricsObj, gFontMetrics_fieldID.descent, <span class="built_in">SkScalarToFloat</span>(metrics.fDescent));</span><br><span class="line">        env-&gt;<span class="built_in">SetFloatField</span>(metricsObj, gFontMetrics_fieldID.bottom, <span class="built_in">SkScalarToFloat</span>(metrics.fBottom));</span><br><span class="line">        env-&gt;<span class="built_in">SetFloatField</span>(metricsObj, gFontMetrics_fieldID.leading, <span class="built_in">SkScalarToFloat</span>(metrics.fLeading));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SkScalarToFloat</span>(spacing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看看具体计算的方法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> SkScalar <span class="title">getMetricsInternal</span><span class="params">(jlong paintHandle, SkFontMetrics *metrics)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> kElegantTop = <span class="number">2500</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> kElegantBottom = <span class="number">-1000</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> kElegantAscent = <span class="number">1900</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> kElegantDescent = <span class="number">-500</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> kElegantLeading = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// 根据paintHandle生成Paint对象</span></span><br><span class="line">    Paint* paint = <span class="built_in">reinterpret_cast</span>&lt;Paint*&gt;(paintHandle);</span><br><span class="line">    <span class="comment">// 获取到字体</span></span><br><span class="line">    SkFont* font = &amp;paint-&gt;<span class="built_in">getSkFont</span>();</span><br><span class="line">    <span class="type">const</span> Typeface* typeface = paint-&gt;<span class="built_in">getAndroidTypeface</span>();</span><br><span class="line">    typeface = Typeface::<span class="built_in">resolveDefault</span>(typeface);</span><br><span class="line">    <span class="comment">// 设置字体样式</span></span><br><span class="line">    minikin::FakedFont baseFont = typeface-&gt;fFontCollection-&gt;<span class="built_in">baseFontFaked</span>(typeface-&gt;fStyle);</span><br><span class="line">    <span class="type">float</span> saveSkewX = font-&gt;<span class="built_in">getSkewX</span>();</span><br><span class="line">    <span class="type">bool</span> savefakeBold = font-&gt;<span class="built_in">isEmbolden</span>();</span><br><span class="line">    MinikinFontSkia::<span class="built_in">populateSkFont</span>(font, baseFont.font-&gt;<span class="built_in">typeface</span>().<span class="built_in">get</span>(), baseFont.fakery);</span><br><span class="line">    <span class="comment">// 根据字体获取到矩阵数据</span></span><br><span class="line">    SkScalar spacing = font-&gt;<span class="built_in">getMetrics</span>(metrics);</span><br><span class="line">    <span class="comment">// The populateSkPaint call may have changed fake bold / text skew</span></span><br><span class="line">    <span class="comment">// because we want to measure with those effects applied, so now</span></span><br><span class="line">    <span class="comment">// restore the original settings.</span></span><br><span class="line">    font-&gt;<span class="built_in">setSkewX</span>(saveSkewX);</span><br><span class="line">    font-&gt;<span class="built_in">setEmbolden</span>(savefakeBold);</span><br><span class="line">    <span class="keyword">if</span> (paint-&gt;<span class="built_in">getFamilyVariant</span>() == minikin::FamilyVariant::ELEGANT) &#123;</span><br><span class="line">       <span class="comment">// 根据size 计算ascent等数据，再进行赋值</span></span><br><span class="line">        SkScalar size = font-&gt;<span class="built_in">getSize</span>();</span><br><span class="line">        metrics-&gt;fTop = -size * kElegantTop / <span class="number">2048</span>;</span><br><span class="line">        metrics-&gt;fBottom = -size * kElegantBottom / <span class="number">2048</span>;</span><br><span class="line">        metrics-&gt;fAscent = -size * kElegantAscent / <span class="number">2048</span>;</span><br><span class="line">        metrics-&gt;fDescent = -size * kElegantDescent / <span class="number">2048</span>;</span><br><span class="line">        metrics-&gt;fLeading = size * kElegantLeading / <span class="number">2048</span>;</span><br><span class="line">        spacing = metrics-&gt;fDescent - metrics-&gt;fAscent + metrics-&gt;fLeading;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> spacing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2020-x2F-10-x2F-20"><a href="#2020-x2F-10-x2F-20" class="headerlink" title="2020&#x2F;10&#x2F;20"></a>2020&#x2F;10&#x2F;20</h2><h3 id="MacOS中，下载的应用打开时，提示无法打开的修复方案"><a href="#MacOS中，下载的应用打开时，提示无法打开的修复方案" class="headerlink" title="MacOS中，下载的应用打开时，提示无法打开的修复方案"></a>MacOS中，下载的应用打开时，提示无法打开的修复方案</h3><p>该情况可能是应用的压缩包在加压缩的时候破坏了应用的权限，所以可以点击应用，右键显示包内容，然后找到MaxOS文件夹，这个时候在命令行中执行命令<code>chmod +x /User/xxxx/xxx/xx.app/Contents/MacOS/xx.app</code>，修改了应用的权限后，就可以打开了</p>
<h3 id="利用GitHub-jsDelivr-PicGo构建免费的图床"><a href="#利用GitHub-jsDelivr-PicGo构建免费的图床" class="headerlink" title="利用GitHub+jsDelivr+PicGo构建免费的图床"></a>利用GitHub+jsDelivr+PicGo构建免费的图床</h3><p>这里有一篇文章有基本的教程<a target="_blank" rel="noopener" href="https://www.itrhx.com/2019/08/01/A27-image-hosting/">传送门</a>，但是里面有一点细节没有说，那就是如果不需要发布<strong>release版本来控制图片资源</strong>，在<strong>PicGo</strong>中设置自定义Url的时候需要在仓库名后加上分支的名字，如<code>xxxxx/Github用户名/图床仓库名@仓库分支/路径</code>，而且仓库需要是<code>Public</code>状态，这样才能访问到我们放在仓库中的资源，否则会一直报错<code>failed to fetch xxxx</code>，。</p>
<h2 id="2020-x2F-10-x2F-31"><a href="#2020-x2F-10-x2F-31" class="headerlink" title="2020&#x2F;10&#x2F;31"></a>2020&#x2F;10&#x2F;31</h2><h3 id="关于Kotlin中的排序"><a href="#关于Kotlin中的排序" class="headerlink" title="关于Kotlin中的排序"></a>关于Kotlin中的排序</h3><p><code>sort()</code>方法是升序排序，<code>sortByDescing()</code>是降序排序，如果需要多个条件来排序，可以使用<strong>Compartor</strong>来辅助排序</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list.sortWith(Compartor&#123; o1, o2 -&gt;</span><br><span class="line">        <span class="comment">// 这里需要返回一个int值，这个值的意义就是，等于0就是相等，大于0 就是o1 排在o2 前面，小于则相反,o2 排在o1前面</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Kotlin中二维和三维数组的初始化"><a href="#Kotlin中二维和三维数组的初始化" class="headerlink" title="Kotlin中二维和三维数组的初始化"></a>Kotlin中二维和三维数组的初始化</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> two = Array&lt;IntArray&gt; &#123; IntArray(<span class="number">2</span>) &#125;</span><br><span class="line"><span class="keyword">val</span> three = Array&lt;Array&lt;IntArrat&gt;&gt; &#123; Array&lt;IntArray&gt; &#123; IntArray(<span class="number">3</span>) &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>##2020&#x2F;12&#x2F;30</p>
<h3 id="git-fatal-refusing-to-merge-unrelated-histories-解决方案"><a href="#git-fatal-refusing-to-merge-unrelated-histories-解决方案" class="headerlink" title="git fatal: refusing to merge unrelated histories 解决方案"></a>git fatal: refusing to merge unrelated histories 解决方案</h3><p>在<strong>merge</strong>或者<strong>rebase</strong>中，出现该错误是因为两个分支没有取得联系，解决方案是在命令后面增加<code>--allow-unrelated-histories</code>,如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge master --allow-unrelated-histories</span><br></pre></td></tr></table></figure>

<h3 id="git-修改初始化时默认分支名称"><a href="#git-修改初始化时默认分支名称" class="headerlink" title="git 修改初始化时默认分支名称"></a>git 修改初始化时默认分支名称</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global init.defaultBranch main</span><br></pre></td></tr></table></figure>

<h2 id="2021-x2F-02-x2F-24"><a href="#2021-x2F-02-x2F-24" class="headerlink" title="2021&#x2F;02&#x2F;24"></a>2021&#x2F;02&#x2F;24</h2><h3 id="MacOS-11-1-设置标签页管理"><a href="#MacOS-11-1-设置标签页管理" class="headerlink" title="MacOS 11.1 设置标签页管理"></a>MacOS 11.1 设置标签页管理</h3><p>在<code>系统偏好设置-&gt;通用-&gt;标签页管理中</code>将选项设置为永不</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/image-20210224094917203.png" alt="image-20210224094917203"></p>
<h3 id="Gitlab配置ssh时，一直无法连接远端服务器的原因"><a href="#Gitlab配置ssh时，一直无法连接远端服务器的原因" class="headerlink" title="Gitlab配置ssh时，一直无法连接远端服务器的原因"></a>Gitlab配置ssh时，一直无法连接远端服务器的原因</h3><ul>
<li>没有<code>known_host</code>，如果是缺少这个，在执行<code>clone</code>命令后，会出现一个提问，需要手动输入<code>yes</code>，这样就会将对于的<code>ip</code>新增到<code>known_host</code>中。</li>
<li>使用<code>ssh</code>代理，执行命令<code>ssh-add xxx/xxx/.ssh/id_rsa</code>，这样将生成的私钥添加到代理中。</li>
<li>gitlab有对秘钥长度的要求，默认生成的秘钥长度是1024的，需要2048以上的。所以生成公钥的命令需要添加长度参数<code>ssh-keygen -t rsa -b 2048 -C &quot;email@example.com&quot;</code></li>
<li>如果生成邮箱的公钥不成功，就生成一个用户名的公钥，用户名在登录时的名称。生成多个公钥的命令是<code>ssh-keygen -t rsa -b 2048 -C &quot;name&quot; -f xxx/xxx/.ssh/name</code>，这样在<code>xxx/xxx/.ssh</code>文件夹下面就会生成<code>name</code>和<code>name.pub</code>。这个地方，<strong>一般都是有官方文档的，按照官方文档的操作就可以，因为不同的版本可能有不同的配置需要</strong></li>
</ul>
<p>最后进行测试<code>ssh -T git@gitlab.com</code>，出现<code>successful</code>就表示成功了。</p>
<h4 id="tips：Mac中复制的命令"><a href="#tips：Mac中复制的命令" class="headerlink" title="tips：Mac中复制的命令"></a>tips：Mac中复制的命令</h4><p><code>pbcopy &lt; ~/.ssh/id_ed25519.pub</code></p>
<h2 id="2021-x2F-02-x2F-25"><a href="#2021-x2F-02-x2F-25" class="headerlink" title="2021&#x2F;02&#x2F;25"></a>2021&#x2F;02&#x2F;25</h2><h3 id="The-application-could-not-be-installed-INSTALL-FAILED-TEST-ONLY-错误"><a href="#The-application-could-not-be-installed-INSTALL-FAILED-TEST-ONLY-错误" class="headerlink" title="The application could not be installed: INSTALL_FAILED_TEST_ONLY 错误"></a>The application could not be installed: INSTALL_FAILED_TEST_ONLY 错误</h3><p>在<code>gradle.properties</code>中添加<code>android.injected.testOnly=false</code></p>
<h2 id="2021-x2F-03-x2F-01"><a href="#2021-x2F-03-x2F-01" class="headerlink" title="2021&#x2F;03&#x2F;01"></a>2021&#x2F;03&#x2F;01</h2><ul>
<li>编译新项目时，出现app的<code>gradle</code>有<strong>NoSuchMethod</strong>之类的错误，大概率是gradle插件版本的问题，在<code>root</code>的gradle中修改<code>com.android.tools.build:gradle</code>的版本就好了</li>
<li><code>SSL peer shut down incorrectly</code>错误大概率的是仓库的问题引起的，添加<code>maven &#123; url &#39;http://maven.aliyun.com/nexus/content/groups/public/&#39; &#125;</code></li>
</ul>
<h2 id="2021-x2F-03-x2F-03"><a href="#2021-x2F-03-x2F-03" class="headerlink" title="2021&#x2F;03&#x2F;03"></a>2021&#x2F;03&#x2F;03</h2><ul>
<li>使用<code>merge</code>标签的时候，预览的属性是<code>tools:parentTag=&quot;XXXLayout&quot;</code></li>
<li>使用反射构建特定的参数的构造函数时，通过指明构造函数的类型来实现<code>MyTextView::class.java.getConstructor(Context::class.java, String::class.java).newInstance(this as Context, &quot;Hello&quot;)</code>，如这个是一个自定义view的自定义构造函数。</li>
<li>对于<code>release</code>分支的合并需要在<strong>gitlab</strong>中提交<code>pr</code>进行<code>review 和 merge</code>。</li>
</ul>
<h2 id="2021-x2F-03-x2F-05"><a href="#2021-x2F-03-x2F-05" class="headerlink" title="2021&#x2F;03&#x2F;05"></a>2021&#x2F;03&#x2F;05</h2><ul>
<li><p><strong>clashX</strong>配置自定义的域名，在控制台中查看你访问的网站的域名后，直接复制到本地配置的<code>.yaml</code>文件中生效就行了，之前配置没有生效是因为域名配置出错了。</p>
</li>
<li><p>在<code>github actions</code>的<code>yaml</code>脚本中，可以根据条件来检查是否需要执行整个脚本</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/ci_yaml_check_commit_info.png" alt="ci_yaml_check_commit_info"></p>
<p>如上，这句是配置到<code>yaml</code>中的，当本次<code>commit</code>信息中包涵了**[Released]**的字符串，才会执行后续的脚本</p>
</li>
</ul>
<h2 id="2021-x2F-03-x2F-09"><a href="#2021-x2F-03-x2F-09" class="headerlink" title="2021&#x2F;03&#x2F;09"></a>2021&#x2F;03&#x2F;09</h2><ul>
<li><p>优化编译的速度配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># custom Android Studio properties</span><br><span class="line"></span><br><span class="line"># 开启gradle并行编译，开启daemon，调整jvm内存大小</span><br><span class="line">org.gradle.daemon=<span class="literal">true</span></span><br><span class="line">org.gradle.configureondemand=<span class="literal">true</span></span><br><span class="line">org.gradle.parallel=<span class="literal">true</span></span><br><span class="line">org.gradle.jvmargs=-Xmx4096m -<span class="attr">XX:</span>MaxPermSize=<span class="number">1024</span>m -<span class="attr">XX:</span>+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line"># 开启gradle缓存</span><br><span class="line">org.gradle.caching=<span class="literal">true</span></span><br><span class="line">android.enableBuildCache=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># 开启kotlin的增量和并行编译</span><br><span class="line">kotlin.incremental=<span class="literal">true</span></span><br><span class="line">kotlin.incremental.java=<span class="literal">true</span></span><br><span class="line">kotlin.incremental.js=<span class="literal">true</span></span><br><span class="line">kotlin.caching.enabled=<span class="literal">true</span></span><br><span class="line">kotlin.parallel.tasks.<span class="keyword">in</span>.project=<span class="literal">true</span> <span class="comment">//开启kotlin并行编译</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 优化kapt</span><br><span class="line">kapt.use.worker.api=<span class="literal">true</span> <span class="comment">//并行运行kapt1.2.60版本以上支持</span></span><br><span class="line">kapt.incremental.apt=<span class="literal">true</span> <span class="comment">//增量编译 kapt1.3.30版本以上支持</span></span><br><span class="line"># kapt avoiding 如果用kapt依赖的内容没有变化，会完全重用编译内容，省掉最上图中的:<span class="attr">app:</span>kaptGenerateStubsDebugKotlin的时间</span><br><span class="line">kapt.include.compile.classpath=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2021-x2F-03-x2F-10"><a href="#2021-x2F-03-x2F-10" class="headerlink" title="2021&#x2F;03&#x2F;10"></a>2021&#x2F;03&#x2F;10</h2><ul>
<li><p>处理前后台的判断标志</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTrimMemory</span><span class="params">(level: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onTrimMemory(level)</span><br><span class="line">  </span><br><span class="line">       <span class="comment">// TRIM_MEMORY_UI_HIDDEN是UI不可见的回调, 通常程序进入后台后都会触发此回调,大部分手机多是回调这个参数</span></span><br><span class="line">       <span class="comment">// TRIM_MEMORY_BACKGROUND也是程序进入后台的回调, 不同厂商不太一样, 魅族手机就是回调这个参数</span></span><br><span class="line">       <span class="keyword">if</span> (level == Application.TRIM_MEMORY_UI_HIDDEN || level == Application.TRIM_MEMORY_BACKGROUND) &#123;</span><br><span class="line">           NormalDialogScheduleUtil.setHoldLaunchState()</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2021-x2F-03-x2F-11"><a href="#2021-x2F-03-x2F-11" class="headerlink" title="2021&#x2F;03&#x2F;11"></a>2021&#x2F;03&#x2F;11</h2><ul>
<li><p><del><code>ssh-add -K ~/.ssh/name</code>将代理添加到钥匙串中，这样每次重启都不要手动添加代理到<code>ssh</code>中</del></p>
</li>
<li><p>在<code>kotlin</code>中，<strong>For</strong>循环关于<code>continue</code>和<code>break</code>的效果，如果在<strong>For</strong>循环后添加标签并返回，实现的是<code>continue</code>的效果。要达到<code>break</code>的效果，需要在<strong>For</strong>循环外加一层<code>dsl</code>的标签，然后<code>return</code>外层的标签，伪代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/kotlin_continue_break.png" alt="kotlin_continue_break"></p>
</li>
<li><p><strong>Android Studio</strong>配置<code>gradle</code>的内存</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">##开启守护线程</span><br><span class="line">#org.gradle.daemon=<span class="literal">true</span></span><br><span class="line">##设置jvm内存大小</span><br><span class="line">#org.gradle.jvmargs=-Xmx2048m -<span class="attr">XX:</span>MaxPermSize=<span class="number">512</span>m -<span class="attr">XX:</span>+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF<span class="number">-8</span></span><br><span class="line">##开启并行编译任务</span><br><span class="line">#org.gradle.parallel=<span class="literal">true</span></span><br><span class="line">##启用新的孵化模式</span><br><span class="line">#org.gradle.configureondemand=<span class="literal">true</span></span><br><span class="line">##开启 Gradle 缓存</span><br><span class="line">#org.gradle.caching = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><h1 id="It-is-currently-in-use-by-another-Gradle-instance-错误的解决方案"><a href="#It-is-currently-in-use-by-another-Gradle-instance-错误的解决方案" class="headerlink" title="It is currently in use by another Gradle instance 错误的解决方案"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21523508/it-is-currently-in-use-by-another-gradle-instance">It is currently in use by another Gradle instance</a> 错误的解决方案</h1><p><code>find ~/.gradle -type f -name &quot;*.lock&quot; -delete</code></p>
</li>
<li><p>适配不仅仅考虑设备，还有系统版本。</p>
</li>
<li><p>UI的尺寸是不是严格按照ui上传。每次需要问清楚，UI对于手机和平板，竖屏和横屏都要考虑！！</p>
</li>
</ul>
<h3 id="MacOS重启后，ssh-add-代理失效的方案·"><a href="#MacOS重启后，ssh-add-代理失效的方案·" class="headerlink" title="MacOS重启后，ssh-add 代理失效的方案·"></a>MacOS重启后，ssh-add 代理失效的方案·</h3><p>上诉方法不管用了，可以使用<code>macOS</code>自带的<strong>automator</strong>软件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/auto-add-start.jpg" alt="auto-add-start"></p>
<p>然后选择<code>运行shell脚本</code>，添加<code>ssh-add</code>添加代理的命令。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/auto-add-shell.jpg" alt="auto-add-shell"></p>
<p>保存好了<code>app</code>后，在系统的偏好设置中选择<code>用户与群组</code>-&gt;<code>登陆项</code>，将刚刚生成的<code>app</code>添加到开机启动中。</p>
<p><strong>这个方案还可以配置在Finder中打开终端</strong></p>
<h2 id="2021-x2F-03-x2F-12"><a href="#2021-x2F-03-x2F-12" class="headerlink" title="2021&#x2F;03&#x2F;12"></a>2021&#x2F;03&#x2F;12</h2><ul>
<li>代码中存在除法的逻辑时，需要检查除数是否为0的情况，否则会报错的。</li>
<li>Uri的url需要判断null，在魅族5.0的设备存在崩溃的问题。</li>
</ul>
<h2 id="2021-x2F-03-x2F-14"><a href="#2021-x2F-03-x2F-14" class="headerlink" title="2021&#x2F;03&#x2F;14"></a>2021&#x2F;03&#x2F;14</h2><h3 id="ssh多配置"><a href="#ssh多配置" class="headerlink" title="ssh多配置"></a>ssh多配置</h3><ol>
<li><p>先按照网站配置教程生成对应的公钥秘钥，生成方法在前面；</p>
</li>
<li><p>在<code>~/.ssh/</code>目录下生成一个<strong>config</strong>文件，直接<code>touch config</code>，在里面编辑以下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github</span></span><br><span class="line">Host github.com</span><br><span class="line">    HostName github.com</span><br><span class="line">    PreferredAuthentications publickey</span><br><span class="line">    IdentityFile ~/.ssh/github</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 公司内网</span></span><br><span class="line">Host xx.x.x.xxx</span><br><span class="line">    HostName git.xxxx.com</span><br><span class="line">    User xxxx</span><br><span class="line">    PreferredAuthentications publickey</span><br><span class="line">    IdentityFile ~/.ssh/name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是这里的<code>Host</code>，如果是内网的<strong>gitlab</strong>，可以在内网的网站上通过开发者工具<strong>Network</strong>栏目查看内网的<strong>IP</strong>地址，填写在<code>Host</code>这里的，到这里，配置多个<code>ssh</code>已经完成了。</p>
<p><code>HostName 填写公司内网的域名就行了，在浏览器上查看，如gitlab.xxxx.com</code></p>
<p>下面的就是公司内网的，执行命令<code>ssh -T git@git.xxx.com</code>，出现<strong>Welcome，XXX</strong>就成功了。</p>
<p>如果提示需要输入密码，则说明没有配置正确，先试试:<code>ssh-add ~/.ssh/xxx/xxx</code>将密钥添加到ssh中，使用<code>ssh-add -l</code> 查看是否添加成功。</p>
</li>
<li><p>还有可能存在需要配置多个用户的情况，比如公司项目和个人项目同时存在，我们之前一般是通过<code>--globl</code>来设置全局的变量，所以需要先清除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global --<span class="built_in">unset</span> user.name</span><br><span class="line">git config --global --<span class="built_in">unset</span> user.email</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>~/</code>目录下创建两个配置文件<code>.gitconfig-self和.gitconfig-work</code>（没有后缀，直接<code>touch </code>命令创建就好了），分别配置不同的账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[user]</span><br><span class="line">		name = xxx</span><br><span class="line">		email = xxx@163.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后编辑<code>~/.gitconfig</code>这个文件，这个文件是由<code>git</code>自动生成的。新增以下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[includeIf <span class="string">&quot;gitdir:~/self-workspace/&quot;</span>]</span><br><span class="line">    path = .gitconfig-self</span><br><span class="line">[includeIf <span class="string">&quot;gitdir:~/workspace/&quot;</span>]</span><br><span class="line">    path = .gitconfig-work</span><br></pre></td></tr></table></figure>

<p><strong>注意事项：第一，gitdir后面的目录必须是以&#x2F;结尾；第二是两个目录不能有交集</strong></p>
</li>
</ol>
<h3 id="Android-项目中使用ComposingBuild来构建多项目的依赖"><a href="#Android-项目中使用ComposingBuild来构建多项目的依赖" class="headerlink" title="Android 项目中使用ComposingBuild来构建多项目的依赖"></a>Android 项目中使用ComposingBuild来构建多项目的依赖</h3><ol>
<li><p>先通过<strong>new Module</strong>创建一个新的<strong>lib</strong></p>
</li>
<li><p>然后修改这个<strong>lib</strong>的<strong>build.gradle</strong>，如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        <span class="comment">// 因为使用的 Kotlin 需要需要添加 Kotlin 插件</span></span><br><span class="line">        classpath <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:1.3.72&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;kotlin&#x27;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;java-gradle-plugin&#x27;</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    <span class="comment">// 需要添加 jcenter 否则会提示找不到 gradlePlugin</span></span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation gradleApi()</span><br><span class="line">    implementation <span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.3.72&quot;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileKotlin &#123;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">compileTestKotlin &#123;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradlePlugin &#123;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        version &#123;</span><br><span class="line">            <span class="comment">// 在 app 模块需要通过 id 引用这个插件</span></span><br><span class="line">            id = <span class="string">&#x27;com.github.grieey.build-plugin&#x27;</span></span><br><span class="line">            <span class="comment">// 实现这个插件的类的路径</span></span><br><span class="line">            implementationClass = <span class="string">&#x27;com.github.grieey.buildplugin.BuildPlugin&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<strong>setting.gradle</strong>，将<code>include &#39;:lib&#39;</code>修改为<code>includeBuild(&quot;lib&quot;)</code>。重新构建就行了。</p>
</li>
</ol>
<h2 id="2021-x2F-03-x2F-15"><a href="#2021-x2F-03-x2F-15" class="headerlink" title="2021&#x2F;03&#x2F;15"></a>2021&#x2F;03&#x2F;15</h2><ul>
<li>在出现任何一个bug的时候，多考虑一些场景，不仅仅是客户端的问题，还有后端的兼容性。</li>
<li>当下次存在插桩的方式，可以参考一些设计，比如plugin或者register等等。</li>
</ul>
<h2 id="2021-x2F-03-x2F-17"><a href="#2021-x2F-03-x2F-17" class="headerlink" title="2021&#x2F;03&#x2F;17"></a>2021&#x2F;03&#x2F;17</h2><ul>
<li>代码的设计还是不充分，在设计普通测试和特殊测试的时候，应该用一套布局，设计为了两套</li>
<li>textView对于标点符号，有自己的适配规则，可能不符合产品的排版需求</li>
</ul>
<h2 id="2021-x2F-03-x2F-22"><a href="#2021-x2F-03-x2F-22" class="headerlink" title="2021&#x2F;03&#x2F;22"></a>2021&#x2F;03&#x2F;22</h2><ul>
<li>新项目中，新增module可以直接在<code>Config.groovy</code>中，直接修改配置，建立对应的目录就行了。</li>
</ul>
<h2 id="2021-x2F-03-x2F-24"><a href="#2021-x2F-03-x2F-24" class="headerlink" title="2021&#x2F;03&#x2F;24"></a>2021&#x2F;03&#x2F;24</h2><h3 id="It-is-currently-in-use-by-another-Gradle-instance-错误的解决办法"><a href="#It-is-currently-in-use-by-another-Gradle-instance-错误的解决办法" class="headerlink" title="It is currently in use by another Gradle instance 错误的解决办法"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21523508/it-is-currently-in-use-by-another-gradle-instance">It is currently in use by another Gradle instance</a> 错误的解决办法</h3><p>运行命令<code>find ~/.gradle -type f -name &quot;*.lock&quot; -delete</code></p>
<h2 id="2021-x2F-03-x2F-26"><a href="#2021-x2F-03-x2F-26" class="headerlink" title="2021&#x2F;03&#x2F;26"></a>2021&#x2F;03&#x2F;26</h2><h3 id="Android-ActivityThread-reportSizeConfigurations-causes-app-to-freeze-with-black-screen-and-then-crash"><a href="#Android-ActivityThread-reportSizeConfigurations-causes-app-to-freeze-with-black-screen-and-then-crash" class="headerlink" title="Android ActivityThread.reportSizeConfigurations causes app to freeze with black screen and then crash"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46309428/android-activitythread-reportsizeconfigurations-causes-app-to-freeze-with-black">Android ActivityThread.reportSizeConfigurations causes app to freeze with black screen and then crash</a></h3><p>这个崩溃是由于Android系统的BUG，引起的，短暂的做法就是在<code>onResume</code>中进行try catch。完美的解决可以通过hook方法，在运行到该方法时，进行替换为Android 10上面的方法。</p>
<h2 id="2021-x2F-03-x2F-30"><a href="#2021-x2F-03-x2F-30" class="headerlink" title="2021&#x2F;03&#x2F;30"></a>2021&#x2F;03&#x2F;30</h2><h3 id="自定义View布局的问题"><a href="#自定义View布局的问题" class="headerlink" title="自定义View布局的问题"></a>自定义View布局的问题</h3><p><code>onLayout</code>方法中，进行view的自定义布局时，位置是相对父view的数据，比如<code>layout(0, 0, 1, 1)</code>这样就是在左上角，从**(0, 0)到(1,1)**的一个位置。需要注意的是，<code>drawRoundRect</code>也是这样的</p>
<h2 id="2021-x2F-04-x2F-03"><a href="#2021-x2F-04-x2F-03" class="headerlink" title="2021&#x2F;04&#x2F;03"></a>2021&#x2F;04&#x2F;03</h2><h3 id="页面重新绘制的问题"><a href="#页面重新绘制的问题" class="headerlink" title="页面重新绘制的问题"></a>页面重新绘制的问题</h3><p>很多时候都会引起页面重绘制，如旋转屏幕等，所以在做动画时，尽量保证父布局不会动，全力的处理子布局的动画即可。这个时候使用属性动画可以真正的更新，而使用view动画会在重绘后还原。虽然使用<strong>ObjectAnimator</strong>也是真正的修改了位置，但是重新layout后会还原，但是<strong>ViewPropertyAnimator</strong>不会，两者的逻辑仍然需要查看和熟悉。</p>
<h3 id="将Bitmap转换为圆形"><a href="#将Bitmap转换为圆形" class="headerlink" title="将Bitmap转换为圆形"></a>将Bitmap转换为圆形</h3><p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/bitmap_to_circle.png" alt="bitmap_to_circle"></p>
<h3 id="Mac下安装Python3环境"><a href="#Mac下安装Python3环境" class="headerlink" title="Mac下安装Python3环境"></a>Mac下安装Python3环境</h3><ol>
<li>安装<code>HomeBrew</code>，使用命令<code>/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</code>，如果安装过程中出现了<strong>Connection refused</strong>的错误，可以尝试开启命令行的翻墙代理，这里用的<code>clashX</code>，可以直接复制翻墙命令<code>export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</code></li>
<li>执行<code>brew install python</code>进行安装。</li>
<li><code>python3 --version</code>可以查看版本，pip3<strong>是</strong>HomeBrew**版本的别称。</li>
<li>在命令行输出日志中可以看到安装目录<code>Python has been installed as /usr/local/bin/python3</code></li>
</ol>
<h3 id="美化命令行"><a href="#美化命令行" class="headerlink" title="美化命令行"></a>美化命令行</h3><ol>
<li>查看命令行工具<code>cat /etc/shells</code>， 然后先看是不是设置的<code>zsh</code>，通过<code>echo $SHELL</code>查看，不是的话<code>chsh -s /bin/zsh</code>进行设置，然后重启终端；</li>
<li>安装<code>oh-my-zsh</code>的命令<code>sh -c &quot;$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</code>(<strong>PS:同上面一样可能需要翻墙支持</strong>)</li>
<li>下载主题<code>git clone https://github.com/bhilburn/powerlevel9k.git ~/.oh-my-zsh/custom/themes/powerlevel9k</code>，</li>
</ol>
<h3 id="Python小知识"><a href="#Python小知识" class="headerlink" title="Python小知识"></a>Python小知识</h3><ul>
<li>SyntaxError: Non-ASCII character ‘\xe2’ 错误是编码的问题，在文件头上夹<code># -*- coding: utf-8 -*</code>解决</li>
</ul>
<h2 id="2021-x2F-04-x2F-08"><a href="#2021-x2F-04-x2F-08" class="headerlink" title="2021&#x2F;04&#x2F;08"></a>2021&#x2F;04&#x2F;08</h2><ul>
<li>所有的<strong>Kotlin与Java交互都是可为Null的，还有控件Id和Kotlin交互</strong></li>
</ul>
<h2 id="2021-x2F-04-x2F-14"><a href="#2021-x2F-04-x2F-14" class="headerlink" title="2021&#x2F;04&#x2F;14"></a>2021&#x2F;04&#x2F;14</h2><h3 id="kotlin中实现注解限制范围"><a href="#kotlin中实现注解限制范围" class="headerlink" title="kotlin中实现注解限制范围"></a>kotlin中实现注解限制范围</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(AnnotationTarget.VALUE_PARAMETER, AnnotationTarget.FIELD)</span></span><br><span class="line">   <span class="meta">@MustBeDocumented</span></span><br><span class="line">   <span class="meta">@IntDef(</span></span><br><span class="line"><span class="meta">       WINDOW_MODE_DEFAULT,</span></span><br><span class="line"><span class="meta">       WINDOW_MODE_APPICATION_SINGLE,</span></span><br><span class="line"><span class="meta">       WINDOW_MODE_ACTIVITY_SINGLE,</span></span><br><span class="line"><span class="meta">       WINDOW_MODE_PAGE_SINGLE</span></span><br><span class="line"><span class="meta">   )</span></span><br><span class="line">   <span class="meta">@kotlin</span>.<span class="keyword">annotation</span>.Retention(AnnotationRetention.SOURCE)</span><br><span class="line">   <span class="keyword">annotation</span></span><br><span class="line">   <span class="keyword">class</span> <span class="title class_">Mode</span></span><br></pre></td></tr></table></figure>

<h2 id="2021-x2F-04-x2F-20"><a href="#2021-x2F-04-x2F-20" class="headerlink" title="2021&#x2F;04&#x2F;20"></a>2021&#x2F;04&#x2F;20</h2><ul>
<li><code>curl</code>是一种命令行联网的工具。</li>
</ul>
<h2 id="2021-x2F-04-x2F-23"><a href="#2021-x2F-04-x2F-23" class="headerlink" title="2021&#x2F;04&#x2F;23"></a>2021&#x2F;04&#x2F;23</h2><h3 id="Rust：-Blocking-waiting-for-file-lock-on-package-cache-解决方案"><a href="#Rust：-Blocking-waiting-for-file-lock-on-package-cache-解决方案" class="headerlink" title="Rust： Blocking waiting for file lock on package cache 解决方案"></a>Rust： Blocking waiting for file lock on package cache 解决方案</h3><p>执行<code>rm -rf ~/.cargo/.package-cache</code>和<code>rm -rf rm -rf ~/.cargo/registry/index/*</code></p>
<h2 id="2021-x2F-04-x2F-27"><a href="#2021-x2F-04-x2F-27" class="headerlink" title="2021&#x2F;04&#x2F;27"></a>2021&#x2F;04&#x2F;27</h2><ul>
<li><p><strong>Gradle权威指南中</strong>第<strong>4.5</strong>节的例子中，直接跑源码无法执行，实现自定义task可以用以下的方式实现</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/gradle_custom_task.png" alt="gradle_custom_task"></p>
<p>执行<code>./gradlew cus</code>后，会依次打印<code>excute first action , excute self , excute last action</code>。</p>
</li>
</ul>
<h3 id="配置zsh"><a href="#配置zsh" class="headerlink" title="配置zsh"></a>配置zsh</h3><p>如果配置了<strong>zsh</strong>，有时候配置<code>.bash_profile</code>文件没有生效，需要在<strong>zsh</strong>的配置文件中添加代码，<code>vim ~/.zshrc</code>找到<code># User Configuration</code>添加一行<code>source ~/.bash_profile</code>的代码，再执行<code>source ~/.zshrc</code>后，重启命令行工具就行了</p>
<h2 id="2021-x2F-04-x2F-28"><a href="#2021-x2F-04-x2F-28" class="headerlink" title="2021&#x2F;04&#x2F;28"></a>2021&#x2F;04&#x2F;28</h2><h3 id="groovy转kts"><a href="#groovy转kts" class="headerlink" title="groovy转kts"></a>groovy转kts</h3><ul>
<li><p><code>setting.gradle</code>的修改<code>include</code>的调用是方法，修改为<code>include(&quot;:xxx&quot;)</code>。</p>
</li>
<li><p>创建task的方式</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tasks.create&lt;Delete&gt;(<span class="string">&quot;clean&quot;</span>) &#123;</span><br><span class="line">    delete = setOf(rootProject.buildDir)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置plugin和buildSrc"><a href="#配置plugin和buildSrc" class="headerlink" title="配置plugin和buildSrc"></a>配置plugin和buildSrc</h3><ul>
<li><p>在<strong>plugin</strong>目录下新建<code>buildSrc</code>目录，依次建立以下文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buildSrc</span><br><span class="line"> ---src</span><br><span class="line"> 	---main</span><br><span class="line"> 		---kotlin</span><br><span class="line"> 			---Deps.kt</span><br><span class="line"> ---build.gradle.src</span><br></pre></td></tr></table></figure>

<p>然后在<code>build.gradle.kts</code>中至少需要配置<code>plugins</code>有<code>kotlin-dsl</code>，我的配置如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/gradle_buildsrc_build.png" alt="gradle_buildsrc_build"></p>
<p>最后设置</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/gradle_buildsrc_kotlin_source_set.png" alt="gradle_buildsrc_kotlin_source_set"></p>
</li>
<li><p><strong>kts</strong>配置<strong>plugin</strong>时，必须带上<strong>version</strong>，并不是所有的<strong>plugin</strong>支持单引号的语法，应该是需要配置<strong>version</strong>的就不支持，需要使用<code>id(&quot;pluginId&quot;) version &quot;&quot;</code> 这样的方式。</p>
</li>
</ul>
<h2 id="2021-x2F-05-x2F-07"><a href="#2021-x2F-05-x2F-07" class="headerlink" title="2021&#x2F;05&#x2F;07"></a>2021&#x2F;05&#x2F;07</h2><h3 id="手机连上chorme调试h5"><a href="#手机连上chorme调试h5" class="headerlink" title="手机连上chorme调试h5"></a>手机连上chorme调试h5</h3><p><code>chrome://inspect/#devices</code>浏览器中输入这个就行了。</p>
<h2 id="2021-x2F-05-x2F-12"><a href="#2021-x2F-05-x2F-12" class="headerlink" title="2021&#x2F;05&#x2F;12"></a>2021&#x2F;05&#x2F;12</h2><h3 id="Grid分割线写法"><a href="#Grid分割线写法" class="headerlink" title="Grid分割线写法"></a>Grid分割线写法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemOffsets</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            outRect: <span class="type">Rect</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            view: <span class="type">View</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            parent: <span class="type">RecyclerView</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            state: <span class="type">RecyclerView</span>.<span class="type">State</span></span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> position = parent.getChildAdapterPosition(view)</span><br><span class="line">            <span class="keyword">val</span> column = position % spanCount</span><br><span class="line"></span><br><span class="line">            outRect.left = column * spacing / spanCount</span><br><span class="line">            outRect.right = spacing - (column + <span class="number">1</span>) * spacing / spanCount</span><br><span class="line"></span><br><span class="line">            outRect.bottom = bottomSpacing</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2021-x2F-05-x2F-19"><a href="#2021-x2F-05-x2F-19" class="headerlink" title="2021&#x2F;05&#x2F;19"></a>2021&#x2F;05&#x2F;19</h2><ul>
<li><code>deepLink</code>项目是使用的<strong>yarn</strong>来配置的，用<strong>npm</strong>构建的。首先装<strong>npm</strong>，命令是<code>brew install npm</code>。用<code>npm --version</code>查看是否安装成功。</li>
<li>然后在项目根目录下跑<code>yarn start</code>。</li>
<li>用<code>ifconfig</code>查看本机<strong>IP</strong>，在手机浏览器中访问即可测试。</li>
</ul>
<h3 id="DiffUtil的使用心得"><a href="#DiffUtil的使用心得" class="headerlink" title="DiffUtil的使用心得"></a>DiffUtil的使用心得</h3><ul>
<li><code>areItemsTheSame</code>方法返回的是数据源是否一致，一般用<strong>ID</strong>这种比较核心的来进行比较</li>
<li><code>areContentsTheSame</code>方法返回的是内容是否一致，也就是数据是否更新了局部，这个可以用于状态或者进度之类的局部更新</li>
<li><code>getChangePayload</code>用于局部更新，这个方法重写，才会对同一个数据源返回同一个<strong>ViewHolder</strong>，方便处理view上的一些状态。如果这样做，需要对ViewHolder中的所有状态进行控制，以防止复用。</li>
<li><code>Lottie</code>动画在<strong>RecyclerView</strong>同一个<strong>ViewHolder</strong>调用<code>playAnimation</code>无效，因为这个方法内部调用的<code>isShown()</code>一直返回的<strong>false</strong>。这也是官方库的一个<a target="_blank" rel="noopener" href="https://github.com/airbnb/lottie-android/issues/1495">Issue</a>。解决方案是使用<code>View.post&#123; playAnimation() &#125;</code>，需要注意的是在<code>post</code>中<strong>需要判断view是否为null</strong>。</li>
</ul>
<h2 id="2021-x2F-05-x2F-26"><a href="#2021-x2F-05-x2F-26" class="headerlink" title="2021&#x2F;05&#x2F;26"></a>2021&#x2F;05&#x2F;26</h2><h3 id="ViewPager2中使用Recyclerview的adapter会抛出-java-lang-IllegalStateException-Pages-must-fill-the-whole-ViewPager2-use-match-parent"><a href="#ViewPager2中使用Recyclerview的adapter会抛出-java-lang-IllegalStateException-Pages-must-fill-the-whole-ViewPager2-use-match-parent" class="headerlink" title="ViewPager2中使用Recyclerview的adapter会抛出 java.lang.IllegalStateException: Pages must fill the whole ViewPager2 (use match_parent)"></a>ViewPager2中使用Recyclerview的adapter会抛出 java.lang.IllegalStateException: Pages must fill the whole ViewPager2 (use match_parent)</h3><p>这里的解决方案是在创建<strong>ViewHolder</strong>时，需要设置<strong>LayoutParams</strong>都为<strong>MATCH_PARENT</strong></p>
<h2 id="2021-x2F-06-x2F-17"><a href="#2021-x2F-06-x2F-17" class="headerlink" title="2021&#x2F;06&#x2F;17"></a>2021&#x2F;06&#x2F;17</h2><h3 id="在rootProject的build-gradle的buildScript的block中无法引用buildSrc的问题"><a href="#在rootProject的build-gradle的buildScript的block中无法引用buildSrc的问题" class="headerlink" title="在rootProject的build.gradle的buildScript的block中无法引用buildSrc的问题"></a>在rootProject的build.gradle的buildScript的block中无法引用buildSrc的问题</h3><p>因为这个代码块的执行在当前的gradle之前，所以当前gradle中import的代码执行也在block之后，就无法引用到对应的类，解决方案是不使用<strong>import</strong>，在调用时直接使用全限定类名来调用即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        <span class="comment">// configs是包名，Project是类</span></span><br><span class="line">        <span class="keyword">if</span> (configs.Project.canDependenciedLocalAar(gradle)) &#123;</span><br><span class="line">            maven(<span class="string">&quot;file://<span class="subst">$&#123;rootDir.absolutePath&#125;</span>/repo&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        maven(<span class="string">&quot;https://jitpack.io&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="项目中新老项目的实现方案"><a href="#项目中新老项目的实现方案" class="headerlink" title="项目中新老项目的实现方案"></a>项目中新老项目的实现方案</h3><p>在新项目中，将每个base、core相关的module单独打包，然后在老项目中统一依赖</p>
<h2 id="2021-x2F-06-x2F-21"><a href="#2021-x2F-06-x2F-21" class="headerlink" title="2021&#x2F;06&#x2F;21"></a>2021&#x2F;06&#x2F;21</h2><h3 id="Fragment的构造方法私有后引发的报错"><a href="#Fragment的构造方法私有后引发的报错" class="headerlink" title="Fragment的构造方法私有后引发的报错"></a>Fragment的构造方法私有后引发的报错</h3><p>在<code>Fragment</code>方法中，有以下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Fragment <span class="title function_">instantiate</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> String fname,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> Bundle args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;? <span class="keyword">extends</span> <span class="title class_">Fragment</span>&gt; clazz = FragmentFactory.loadFragmentClass(</span><br><span class="line">                    context.getClassLoader(), fname);</span><br><span class="line">            <span class="type">Fragment</span> <span class="variable">f</span> <span class="operator">=</span> clazz.getConstructor().newInstance();</span><br><span class="line">            <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">                args.setClassLoader(f.getClass().getClassLoader());</span><br><span class="line">                f.setArguments(args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> f;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.lang.InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InstantiationException</span>(<span class="string">&quot;Unable to instantiate fragment &quot;</span> + fname</span><br><span class="line">                    + <span class="string">&quot;: make sure class name exists, is public, and has an&quot;</span></span><br><span class="line">                    + <span class="string">&quot; empty constructor that is public&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InstantiationException</span>(<span class="string">&quot;Unable to instantiate fragment &quot;</span> + fname</span><br><span class="line">                    + <span class="string">&quot;: make sure class name exists, is public, and has an&quot;</span></span><br><span class="line">                    + <span class="string">&quot; empty constructor that is public&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InstantiationException</span>(<span class="string">&quot;Unable to instantiate fragment &quot;</span> + fname</span><br><span class="line">                    + <span class="string">&quot;: could not find Fragment constructor&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InstantiationException</span>(<span class="string">&quot;Unable to instantiate fragment &quot;</span> + fname</span><br><span class="line">                    + <span class="string">&quot;: calling Fragment constructor caused an exception&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码在<code>restoreState</code>方法执行时，如果<code>fragment</code>的构造私有化后，会报错。因为代码中使用了反射来获取默认构造方法</p>
<h2 id="2022-x2F-04-x2F-12"><a href="#2022-x2F-04-x2F-12" class="headerlink" title="2022&#x2F;04&#x2F;12"></a>2022&#x2F;04&#x2F;12</h2><ul>
<li>github action执行的时候，是将在<strong>github workspace</strong>中，如果存在<strong>gitsubmodule</strong>的话，需要先clone下来，不然会找不到对应的项目；</li>
<li>hexo有比较严格的<strong>npm</strong>版本要求，一定要对应。</li>
</ul>
<h2 id="2022-x2F-04-x2F-13"><a href="#2022-x2F-04-x2F-13" class="headerlink" title="2022&#x2F;04&#x2F;13"></a>2022&#x2F;04&#x2F;13</h2><ul>
<li>生成markdown需要的目录树，执行<code>npm install mddir -g</code>，安装好了之后在指定目录执行<code>mddir</code>，然后在该目录会生成一个md文件，打开复制内容就好了；</li>
</ul>
<h2 id="2022-x2F-04-x2F-14"><a href="#2022-x2F-04-x2F-14" class="headerlink" title="2022&#x2F;04&#x2F;14"></a>2022&#x2F;04&#x2F;14</h2><ul>
<li><p>设置Android Studio在finder中直接打开项目，这样就不用每次都去as中打开了，操作减少了几步。</p>
<ul>
<li><p>首先在<code>~/.bash_profile</code>文件中为Android Studio打开项目添加别名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> as=<span class="string">&quot;open -a /Application/Android Studio4.2.1.app .&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后<code>source ~/.bash_profile</code></p>
</li>
<li><p>再打开苹果的自动操作软件，选择执行Apple Script，在右边窗口输入以下代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">on run &#123;input, parameters&#125;</span><br><span class="line">	tell application &quot;Finder&quot;</span><br><span class="line">		set pathList to (quoted form of POSIX path of (folder of the front window as alias))</span><br><span class="line">	end tell</span><br><span class="line">	</span><br><span class="line">	tell application &quot;System Events&quot;</span><br><span class="line">		do shell script &quot;open -a /Applications/AS.app &quot; &amp; pathList</span><br><span class="line">	end tell</span><br><span class="line">	return input</span><br><span class="line">end run</span><br></pre></td></tr></table></figure>


</li>
<li><p>保存为app。</p>
</li>
<li><p>然后在Application中找到Android Studio,右键显示简介，鼠标选择图标，复制，再到刚刚保存的App的位置，同样的显示简介，选中图标，粘贴。这样就把图标修改为as的了。</p>
</li>
<li><p>最后打开finder，顶部选择显示-&gt;自定义状态栏，把刚刚保存的App拖到工具栏，完成就可以了。</p>
</li>
</ul>
</li>
</ul>
<h2 id="2022-x2F-04-x2F-20"><a href="#2022-x2F-04-x2F-20" class="headerlink" title="2022&#x2F;04&#x2F;20"></a>2022&#x2F;04&#x2F;20</h2><ul>
<li><p>使用<em>Wrap</em>时，无法登录，命令行中设置代理即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span><br><span class="line">/Applications/Warp.app/Contents/MacOS/stable</span><br></pre></td></tr></table></figure>
</li>
<li><p><em>Java</em>中使用反射的时候，调用<code>method.invoke(obj, objectName, functionName, paramStr)</code>,第一个参数<code>obj</code>可以传null，代表调用静态方法；</p>
</li>
</ul>
<h2 id="2022-x2F-04-x2F-21"><a href="#2022-x2F-04-x2F-21" class="headerlink" title="2022&#x2F;04&#x2F;21"></a>2022&#x2F;04&#x2F;21</h2><ul>
<li><code>Build was configured to prefer settings repositories over project repositories but repository &#39;flatDir&#39; was added by plugin &#39;com.rocketx&#39;</code>类似错误的解决方案：将<code>settings.gradle</code>里的<code>repositoriesMode.set(Repositoriest.FAIL_ON_PROJECT_REPOS)</code>修改为<code>repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)</code>;</li>
</ul>
<h2 id="2022-x2F-04-x2F-22"><a href="#2022-x2F-04-x2F-22" class="headerlink" title="2022&#x2F;04&#x2F;22"></a>2022&#x2F;04&#x2F;22</h2><ul>
<li><p>记录下第一次画的像素画</p>
<p><img src="https://cdn.jsdelivr.net/gh/Grieey/ImgHosting@main/img/pixil-frame-0.png" alt="pixil-frame-0"></p>
</li>
</ul>
<h2 id="2022-x2F-05-x2F-05"><a href="#2022-x2F-05-x2F-05" class="headerlink" title="2022&#x2F;05&#x2F;05"></a>2022&#x2F;05&#x2F;05</h2><ul>
<li>约束布局中，<code>bais</code>的计算规则是，控件左边距离约束控件的距离&#x2F;(控件左边距离约束控件的距离+控件右边距离约束控件的距离)</li>
</ul>
<h2 id="2022-x2F-05-x2F-31"><a href="#2022-x2F-05-x2F-31" class="headerlink" title="2022&#x2F;05&#x2F;31"></a>2022&#x2F;05&#x2F;31</h2><ul>
<li><p>在Android11设备上报错<code>java.io.FileNotFoundException open failed: EEXIST (File exists) Android 11</code>是因为Android11上进行了分区存储的设置，这个时候如果没有所有文件的访问权限，则在使用<em>FileOutputStream</em>打开文件时，会抛出上面的错误，(<strong>这个时候通过file.exist()返回的是false，无法判断这种情况</strong>)解决方案如下：</p>
<ul>
<li><p>在<code>Androidmanifest.xml</code>文件中，声明<code>android:requestLegacyExternalStorage=&quot;true&quot;</code>和<code>&lt;uses-permission android:name=&quot;android.permission.MANAGE_EXTERNAL_STORAGE&quot;/&gt;</code>可以进行覆盖安装，但是一旦卸载，就会失效；不过可以一定程度减少用户的操作成本。</p>
</li>
<li><p>在读取文件的地方，进行版本判断，如果是sdk大于了30的，需要用<code>Environment.isExternalStorageManager()</code>判断应用是否有所有文件的访问权限，没有则直接跳转到设置让用户打开。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R &amp;&amp; !Environment.isExternalStorageManager()) &#123;</span><br><span class="line">      <span class="keyword">val</span> permissionIntent = Intent(Settings.ACTION_MANAGE_ALL_FILES_ACCESS_PERMISSION)</span><br><span class="line">      startActivity(permissionIntent)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="2022-x2F-07-x2F-20"><a href="#2022-x2F-07-x2F-20" class="headerlink" title="2022&#x2F;07&#x2F;20"></a>2022&#x2F;07&#x2F;20</h2><ul>
<li>配置hexo的<strong>PERSONAL_TOKEN</strong>，在Github的Setting中，选择<em>DeveloperSetting</em>中的<em>PersonalAccessToken</em>，中间选择Blog那个Token，重新生成一次，然后复制Token，在Blog的仓库中，选择项目的<em>Setting-&gt;Secrets-&gt;Actions</em>，添加一个<strong>HEXO_DEPLOY</strong>，已经有的话就Update，然后填入刚刚复制的Token就行了。</li>
</ul>
<h2 id="2022-x2F-08-x2F-01"><a href="#2022-x2F-08-x2F-01" class="headerlink" title="2022&#x2F;08&#x2F;01"></a>2022&#x2F;08&#x2F;01</h2><ul>
<li>使用<code>@Suppress(&quot;UNCHECKED_CAST&quot;)</code> 来屏蔽<strong>Lint的Unchecked cast</strong>警告。</li>
<li>针对文件中所有的警告忽略<code>@file:Suppress(&quot;UNUSED&quot;, &quot;UNCHECKED_CAST&quot;)</code>。</li>
</ul>
<h2 id="2022-x2F-08-x2F-04"><a href="#2022-x2F-08-x2F-04" class="headerlink" title="2022&#x2F;08&#x2F;04"></a>2022&#x2F;08&#x2F;04</h2><ul>
<li>设置环境变量<em>set variable</em>，不是把变量添加到PATH中，而是在<code>~/.bash_profile</code>文件中设置一个变量，如需要设置<strong>ANDROID_SDK_HOME</strong>，则直接在<code>~/.bash_profile</code>中写入<code>echo ANDROID_SDK_HOME=/usr/xx/xx/xx/Android/sdk</code>即可。</li>
</ul>
<p>	</p>
  </div>
  
    
      <a id="older" class="blog-nav" href="/2019/04/06/%E7%A2%A7%E5%B3%B0%E5%B3%A1%E8%B8%8F%E9%9D%92/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/2020/02/18/Glide%E7%9A%84%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Copyright © Leedom 2021</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Theme by Leedom | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="$ grep...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
